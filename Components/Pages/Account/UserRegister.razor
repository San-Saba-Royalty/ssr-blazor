@page "/account/register"
@using Microsoft.AspNetCore.Components.Web
@using SSRBlazor.Components
@using MudBlazor
@using SSRBusiness.Entities
@using SSRBusiness.BusinessClasses
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject UserRepository UserRepository

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
    <MudText Typo="Typo.h4" GutterBottom="true">Registration</MudText>

    <EditForm Model="@_registerModel" OnValidSubmit="HandleRegistration">
        <DataAnnotationsValidator />
        
        <MudGrid>
            <MudItem xs="12">
                <MudCard Elevation="4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Account Information</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudGrid>
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="User Name" @bind-Value="_registerModel.UserName" 
                                              For="@(() => _registerModel.UserName)" 
                                              Variant="Variant.Outlined" Margin="Margin.Dense" />
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Email" @bind-Value="_registerModel.Email" 
                                              For="@(() => _registerModel.Email)" 
                                              Variant="Variant.Outlined" Margin="Margin.Dense" />
                            </MudItem>

                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Password" @bind-Value="_registerModel.Password" 
                                              For="@(() => _registerModel.Password)" 
                                              InputType="InputType.Password" 
                                              Variant="Variant.Outlined" Margin="Margin.Dense" />
                            </MudItem>

                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Confirm Password" @bind-Value="_registerModel.ConfirmPassword" 
                                              For="@(() => _registerModel.ConfirmPassword)" 
                                              InputType="InputType.Password" 
                                              Variant="Variant.Outlined" Margin="Margin.Dense" />
                            </MudItem>

                            <MudItem xs="12" sm="6">
                                <MudTextField Label="First Name" @bind-Value="_registerModel.FirstName" 
                                              For="@(() => _registerModel.FirstName)" 
                                              Variant="Variant.Outlined" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField Label="Last Name" @bind-Value="_registerModel.LastName" 
                                              For="@(() => _registerModel.LastName)" 
                                              Variant="Variant.Outlined" Margin="Margin.Dense" />
                            </MudItem>
                        </MudGrid>
                    </MudCardContent>
                    <MudCardActions Class="pb-4 pl-4">
                        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="mr-2">Register</MudButton>
                        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="Cancel">Cancel</MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        </MudGrid>
    </EditForm>
</MudContainer>

@code {
    private RegisterModel _registerModel = new();

    private class RegisterModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "User Name is required")]
        [System.ComponentModel.DataAnnotations.MaxLength(35)]
        public string UserName { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Email is required")]
        [System.ComponentModel.DataAnnotations.EmailAddress]
        [System.ComponentModel.DataAnnotations.MaxLength(50)]
        public string Email { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Password is required")]
        [System.ComponentModel.DataAnnotations.MaxLength(35)]
        public string Password { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Password confirmation is required")]
        [System.ComponentModel.DataAnnotations.Compare(nameof(Password), ErrorMessage = "Passwords do not match")]
        public string ConfirmPassword { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "First Name is required")]
        [System.ComponentModel.DataAnnotations.MaxLength(20)]
        public string FirstName { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Last Name is required")]
        [System.ComponentModel.DataAnnotations.MaxLength(20)]
        public string LastName { get; set; } = string.Empty;
    }

    private async Task HandleRegistration()
    {
        // Check if user exists
        var existingUser = await UserRepository.LoadUserByUserNameAsync(_registerModel.UserName);
        if (existingUser != null)
        {
            Snackbar.Add("User name already exists.", Severity.Error);
            return;
        }
        
        // Also check email if UserName is distinct from Email in this system, 
        // though legacy seems to use them somewhat interchangeably or at least distinct fields.
        // The legacy UserRegister.aspx.vb uses txtUserName for the LoadUserByUserName check.
        // User entity code: userEntity.Entity.UserName = txtUserName.Text.Trim

        var newUser = new User
        {
            // Note: In strict mapped entity User.cs, the field mapping is:
            // UserName -> Email (Wait, User.cs has Email property, but no separate UserName property?)
            // Let's re-verify User.cs.
            // User.cs: UserId, FirstName, LastName, Email, Password, Salt, IsActive...
            // It seems 'Email' might be serving as the Username or 'UserId'. 
            // The Legacy code had both UserName and Email.
            // Legacy UserRegister.aspx.vb:
            // userEntity.Entity.UserName = txtUserName.Text.Trim
            // userEntity.Entity.Email = txtEmail.Text.Trim
            //
            // User.cs generated from modern dotnet10:
             // User.cs generated from modern dotnet10:
             // public int UserId { get; set; }
             // public string? UserName { get; set; }
             // 
             // Mapping UserName to UserName, UserId is auto-generated.
              UserName = _registerModel.UserName,
              Email = _registerModel.Email,
              FirstName = _registerModel.FirstName,
              LastName = _registerModel.LastName,
              IsActive = false // Default to inactive as per legacy
        };

        try 
        {
            await UserRepository.CreateUserAsync(newUser, _registerModel.Password);
            Snackbar.Add("Registration successful! Please login.", Severity.Success);
            Navigation.NavigateTo("/account/login");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating user: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel() => Navigation.NavigateTo("/account/login");
}
