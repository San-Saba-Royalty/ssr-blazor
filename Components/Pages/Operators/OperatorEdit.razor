@page "/operator/edit/{Id:int}"
@page "/Operator/OperatorEdit"
@using SSRBusiness.Entities
@using SSRBlazor.Services
@using SSRBlazor.Components.Pages.Operators.Dialogs
@inject OperatorService OperatorService
@inject LookUpService LookUpService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService

#pragma warning disable CS8602

<PageTitle>Edit Operator - San Saba Royalty</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    @if (_operator == null)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
    }
    else
    {
        <MudPaper Elevation="4" Class="pa-6">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                <MudText Typo="Typo.h5">
                    <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-2 mb-n1" />
                    Edit Operator: @_operator.OperatorName
                </MudText>
                <MudStack Row="true">
                    <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.ArrowBack" OnClick="BackToList">Back to List</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.Delete" OnClick="DeleteOperatorAsync">Delete Operator</MudButton>
                </MudStack>
            </MudStack>

            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
                <MudTabPanel Text="Details" Icon="@Icons.Material.Filled.Info">
                    <MudForm @ref="_form" @bind-IsValid="_formIsValid">
                        <MudGrid>
                            <MudItem xs="12">
                                <MudTextField T="string" Label="Operator Name" @bind-Value="_operator.OperatorName" 
                                              Required="true" RequiredError="Operator Name is required"
                                              Validation="@(new Func<string, Task<string?>>(ValidateName))"
                                              MaxLength="100" Counter="100" />
                            </MudItem>

                            <MudItem xs="12">
                                <MudDivider Class="my-4" />
                                <MudText Typo="Typo.h6">Main Contact</MudText>
                            </MudItem>

                            <MudItem xs="12" sm="6">
                                <MudTextField T="string" Label="Contact Name" @bind-Value="_operator.ContactName" MaxLength="50" Counter="50" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField T="string" Label="Contact Email" @bind-Value="_operator.ContactEmail" 
                                              MaxLength="50" Counter="50" Validation="@(new Func<string, Task<string?>>(ValidateEmail))" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField T="string" Label="Contact Phone" @bind-Value="_operator.ContactPhone" 
                                              MaxLength="24" OnBlur="FormatPhone" HelperText="Format: 000-000-0000" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField T="string" Label="Contact Fax" @bind-Value="_operator.ContactFax" 
                                              MaxLength="24" OnBlur="FormatFax" HelperText="Format: 000-000-0000" />
                            </MudItem>

                            <MudItem xs="12">
                                <MudDivider Class="my-4" />
                                <MudText Typo="Typo.h6">Address</MudText>
                            </MudItem>

                            <MudItem xs="12" sm="6">
                                <MudTextField T="string" Label="Attention" @bind-Value="_operator.Attention" MaxLength="50" Counter="50" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <!-- empty item for spacing -->
                            </MudItem>

                            <MudItem xs="12">
                                <MudTextField T="string" Label="Address Line 1" @bind-Value="_operator.AddressLine1" MaxLength="100" Counter="100" />
                            </MudItem>
                            <MudItem xs="12">
                                <MudTextField T="string" Label="Address Line 2" @bind-Value="_operator.AddressLine2" MaxLength="100" Counter="100" />
                            </MudItem>
                            <MudItem xs="12">
                                <MudTextField T="string" Label="Address Line 3" @bind-Value="_operator.AddressLine3" MaxLength="100" Counter="100" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField T="string" Label="City" @bind-Value="_operator.City" MaxLength="50" Counter="50" />
                            </MudItem>
                            <MudItem xs="12" sm="3">
                                <MudSelect T="string" Label="State" @bind-Value="_operator.StateCode">
                                    <MudSelectItem Value="@((string?)null)">-- Select One --</MudSelectItem>
                                    @foreach (var state in _states)
                                    {
                                        <MudSelectItem Value="state.StateCode">@state.StateCode</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" sm="3">
                                <MudTextField T="string" Label="Zip Code" @bind-Value="_operator.ZipCode" MaxLength="10" />
                            </MudItem>

                            <MudItem xs="12" Class="d-flex justify-end mt-6">
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="UpdateOperatorAsync" Disabled="!_formIsValid || _processing">
                                    @if (_processing)
                                    {
                                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                        <MudText Class="ms-2">Saving...</MudText>
                                    }
                                    else
                                    {
                                        <MudText>Save Changes</MudText>
                                    }
                                </MudButton>
                            </MudItem>
                        </MudGrid>
                    </MudForm>
                </MudTabPanel>

                <MudTabPanel Text="Contacts" Icon="@Icons.Material.Filled.ContactPage">
                    <MudDataGrid T="OperatorContact" Items="_operator.OperatorContacts" Hover="true" Striped="true" FixedHeader="true" Height="400px">
                        <ToolBarContent>
                            <MudText Typo="Typo.h6">Operator Contacts</MudText>
                            <MudSpacer />
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AddContact">Add Contact</MudButton>
                        </ToolBarContent>
                        <Columns>
                            <PropertyColumn Property="x => x.ContactName" Title="Name" />
                            <PropertyColumn Property="x => x.ContactEmail" Title="Email" />
                            <PropertyColumn Property="x => x.ContactPhone" Title="Phone" />
                            <TemplateColumn Title="Address">
                                <CellTemplate>
                                    @($"{context.Item.AddressLine1}, {context.Item.City}, {context.Item.StateCode} {context.Item.ZipCode}")
                                </CellTemplate>
                            </TemplateColumn>
                            <TemplateColumn CellClass="d-flex justify-end">
                                <CellTemplate>
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" OnClick="@(() => EditContact(context.Item))" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => DeleteContactAsync(context.Item))" />
                                </CellTemplate>
                            </TemplateColumn>
                        </Columns>
                    </MudDataGrid>
                </MudTabPanel>
                
                <MudTabPanel Text="Actions" Icon="@Icons.Material.Filled.MoreVert">
                    <MudGrid Class="mt-2">
                        <MudItem xs="12">
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Description" FullWidth="true" OnClick="GenerateCheckStatement">
                                Generate Barcode Check Statement Cover Sheet
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>
            </MudTabs>
        </MudPaper>
    }
</MudContainer>

@code {
    [Parameter] public int Id { get; set; }

    private Operator? _operator;
    private MudForm _form = null!;
    private bool _formIsValid;
    private bool _processing;
    private List<State> _states = new();

    protected override async Task OnInitializedAsync()
    {
        _states = await LookUpService.GetStatesAsync();
        await LoadOperatorAsync();
    }

    private async Task LoadOperatorAsync()
    {
        _operator = await OperatorService.GetOperatorWithContactsAsync(Id);
        if (_operator == null)
        {
            Snackbar.Add("Operator not found", Severity.Error);
            NavigationManager.NavigateTo("/operators");
        }
    }

    private async Task<string?> ValidateName(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return null;
        var exists = await OperatorService.DoesOperatorNameExistAsync(name, Id);
        return exists ? "An operator with this name already exists" : null;
    }

    private async Task<string?> ValidateEmail(string? email)
    {
        if (string.IsNullOrWhiteSpace(email)) return null;
        var isValid = await OperatorService.ValidateEmailAsync(email);
        return isValid ? null : "Invalid email address";
    }

    private void FormatPhone() => _operator!.ContactPhone = FormatPhoneNumber(_operator.ContactPhone);
    private void FormatFax() => _operator!.ContactFax = FormatPhoneNumber(_operator.ContactFax);

    private string? FormatPhoneNumber(string? phone)
    {
        if (string.IsNullOrWhiteSpace(phone)) return phone;
        var digits = new string(phone.Where(char.IsDigit).ToArray());
        if (digits.Length == 7) return $"{digits[..3]}-{digits[3..]}";
        if (digits.Length == 10) return $"{digits[..3]}-{digits[3..6]}-{digits[6..]}";
        if (digits.Length == 11) return $"{digits[0]}-{digits[1..4]}-{digits[4..7]}-{digits[7..]}";
        return phone;
    }

    private void BackToList() => NavigationManager.NavigateTo("/operators");

    private async Task UpdateOperatorAsync()
    {
        await _form.Validate();
        if (!_formIsValid) return;

        _processing = true;
        try
        {
            var op = _operator;
            if (op == null) return;
            var (success, _, error) = await OperatorService.UpdateAsync(op);
            if (success)
            {
                Snackbar.Add("Operator updated successfully", Severity.Success);
            }
            else
            {
                Snackbar.Add(error ?? "Error updating operator", Severity.Error);
            }
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task DeleteOperatorAsync()
    {
        var op = _operator;
        if (op == null) return;
        var parameters = new DialogParameters { ["ContentText"] = $"Are you sure you want to delete operator '{op.OperatorName}'? This action cannot be undone." };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<MudBlazor.MudMessageBox>("Delete Operator", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var (success, error) = await OperatorService.DeleteAsync(Id);
            if (success)
            {
                Snackbar.Add("Operator deleted successfully", Severity.Success);
                NavigationManager.NavigateTo("/operators");
            }
            else
            {
                Snackbar.Add(error ?? "Error deleting operator", Severity.Error);
            }
        }
    }

    private async Task AddContact()
    {
        var parameters = new DialogParameters { ["OperatorID"] = Id };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<OperatorContactDialog>("Add Operator Contact", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadOperatorAsync();
        }
    }

    private async Task EditContact(OperatorContact contact)
    {
        var parameters = new DialogParameters { ["OperatorID"] = Id, ["ContactID"] = contact.OperatorContactID };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<OperatorContactDialog>("Edit Operator Contact", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadOperatorAsync();
        }
    }

    private async Task DeleteContactAsync(OperatorContact contact)
    {
        var parameters = new DialogParameters { ["ContentText"] = $"Are you sure you want to delete contact '{contact.ContactName}'?" };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<MudBlazor.MudMessageBox>("Delete Contact", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var (success, error) = await OperatorService.DeleteContactAsync(contact.OperatorContactID);
            if (success)
            {
                Snackbar.Add("Contact deleted successfully", Severity.Success);
                await LoadOperatorAsync();
            }
            else
            {
                Snackbar.Add("Error deleting contact", Severity.Error);
            }
        }
    }

    private void GenerateCheckStatement()
    {
        NavigationManager.NavigateTo($"/operator/check-statement-capture?oid={Id}");
    }
}
