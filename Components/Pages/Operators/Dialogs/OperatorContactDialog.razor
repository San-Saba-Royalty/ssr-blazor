@using MudBlazor
@using SSRBusiness.Entities
@using SSRBlazor.Services
@inject OperatorService OperatorService
@inject DocumentService DocumentService
@inject LookUpService LookUpService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@(IsEdit ? Icons.Material.Filled.Edit : Icons.Material.Filled.Add)" Class="mr-3 mb-n1" />
            @(IsEdit ? "Edit" : "Add") Operator Contact
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="_formIsValid">
            <MudGrid Spacing="2">
                <MudItem xs="12">
                    <MudSelect T="int" Label="Operator Document" @bind-Value="Contact.DocumentTemplateID" 
                               Required="true" RequiredError="Operator Document is required"
                               Disabled="IsEdit">
                        @foreach (var template in _templates)
                        {
                            <MudSelectItem Value="template.DocumentTemplateID">@template.DocumentTemplateDesc</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField T="string" Label="Contact Name" @bind-Value="Contact.ContactName" 
                                  MaxLength="50" Counter="50" Required="true" RequiredError="Contact Name is required" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField T="string" Label="Contact Email" @bind-Value="Contact.ContactEmail" 
                                  MaxLength="50" Counter="50" Validation="@(new Func<string, Task<string?>>(ValidateEmail))" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField T="string" Label="Contact Phone" @bind-Value="Contact.ContactPhone" 
                                  MaxLength="24" Counter="24" HelperText="Format: 000-000-0000"
                                  Immediate="true" OnBlur="FormatPhone" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField T="string" Label="Contact Fax" @bind-Value="Contact.ContactFax" 
                                  MaxLength="24" Counter="24" HelperText="Format: 000-000-0000"
                                  Immediate="true" OnBlur="FormatFax" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField T="string" Label="Attention" @bind-Value="Contact.Attention" MaxLength="50" Counter="50" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField T="string" Label="Address Line 1" @bind-Value="Contact.AddressLine1" MaxLength="100" Counter="100" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField T="string" Label="Address Line 2" @bind-Value="Contact.AddressLine2" MaxLength="100" Counter="100" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField T="string" Label="Address Line 3" @bind-Value="Contact.AddressLine3" MaxLength="100" Counter="100" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField T="string" Label="City" @bind-Value="Contact.City" MaxLength="50" Counter="50" />
                </MudItem>
                <MudItem xs="12" sm="3">
                    <MudSelect T="string" Label="State" @bind-Value="Contact.StateCode">
                        <MudSelectItem Value="@((string?)null)">-- Select One --</MudSelectItem>
                        @foreach (var state in _states)
                        {
                            <MudSelectItem Value="state.StateCode">@state.StateName</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="3">
                    <MudTextField T="string" Label="Zip Code" @bind-Value="Contact.ZipCode" MaxLength="10" />
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit" Disabled="!_formIsValid">@(IsEdit ? "Update" : "Add")</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter] public OperatorContact Contact { get; set; } = new();
    [Parameter] public bool IsEdit { get; set; }

    private MudForm _form = null!;
    private bool _formIsValid;
    private List<DocumentTemplate> _templates = new();
    private List<State> _states = new();

    protected override async Task OnInitializedAsync()
    {
        _states = await LookUpService.GetStatesAsync();
        
        // Filter out templates already assigned to this operator (legacy parity)
        var allTemplates = await DocumentService.GetAllAsync(d => d.DocumentTypeCode == "Operator");
        
        // Filter out templates already assigned (if not editing current one)
        var existingContacts = await OperatorService.GetContactsByOperatorIdAsync(Contact.OperatorID);
        var usedTemplateIds = existingContacts
            .Where(c => !IsEdit || c.OperatorContactID != Contact.OperatorContactID)
            .Select(c => c.DocumentTemplateID)
            .ToList();

        _templates = allTemplates.Where(t => !usedTemplateIds.Contains(t.DocumentTemplateID)).ToList();

        if (IsEdit && !_templates.Any(t => t.DocumentTemplateID == Contact.DocumentTemplateID))
        {
            // Ensure current template is in list even if it was technically filtered
            var currentTemplate = allTemplates.FirstOrDefault(t => t.DocumentTemplateID == Contact.DocumentTemplateID);
            if (currentTemplate != null) _templates.Insert(0, currentTemplate);
        }
    }

    private async Task<string?> ValidateEmail(string? email)
    {
        if (string.IsNullOrWhiteSpace(email)) return null;
        var isValid = await OperatorService.ValidateEmailAsync(email);
        return isValid ? null : "Invalid email address";
    }

    private void FormatPhone() => Contact.ContactPhone = FormatPhoneNumber(Contact.ContactPhone);
    private void FormatFax() => Contact.ContactFax = FormatPhoneNumber(Contact.ContactFax);

    private string? FormatPhoneNumber(string? phone)
    {
        if (string.IsNullOrWhiteSpace(phone)) return phone;
        
        var digits = new string(phone.Where(char.IsDigit).ToArray());
        if (digits.Length == 7)
            return $"{digits[..3]}-{digits[3..]}";
        if (digits.Length == 10)
            return $"{digits[..3]}-{digits[3..6]}-{digits[6..]}";
        if (digits.Length == 11)
            return $"{digits[0]}-{digits[1..4]}-{digits[4..7]}-{digits[7..]}";
            
        return phone;
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task Submit()
    {
        await _form.Validate();
        if (_formIsValid)
        {
            MudDialog.Close(DialogResult.Ok(Contact));
        }
    }
}
