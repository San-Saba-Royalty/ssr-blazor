@page "/letteragreements"
@page "/letteragreements/index"

@using MudBlazor
@using SSRBusiness.Entities
@using SSRBlazor.Services
@using SSRBlazor.Components.Pages.LetterAgreements.Models

<PageTitle>Letter Agreements</PageTitle>

@* Messages Section *@
@if (!string.IsNullOrEmpty(_displayMessage))
{
    <MudAlert Severity="Severity.Info" Class="mb-2" ShowCloseIcon="true" CloseIconClicked="() => _displayMessage = string.Empty">
        @_displayMessage
    </MudAlert>
}

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <MudAlert Severity="Severity.Error" Class="mb-2" ShowCloseIcon="true" CloseIconClicked="() => _errorMessage = string.Empty">
        @_errorMessage
    </MudAlert>
}

@* Header Section *@
<MudPaper Elevation="1" Class="pa-3 mb-3">
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3" Wrap="Wrap.Wrap">
        <MudText Typo="Typo.h6"><strong>Letter Agreements</strong></MudText>
        
        <MudSpacer />
        
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   Size="Size.Small"
                   OnClick="@NavigateToAcquisitions">
            Mineral Acquisitions
        </MudButton>
        
        <MudButton Variant="Variant.Outlined" 
                   Size="Size.Small"
                   StartIcon="@Icons.Material.Filled.FilterAltOff"
                   OnClick="@ResetFilters">
            Reset Filters
        </MudButton>
        
        <MudButton Variant="Variant.Outlined" 
                   Size="Size.Small"
                   StartIcon="@Icons.Material.Filled.SortByAlpha"
                   OnClick="@ResetSort">
            Reset Sort
        </MudButton>
    </MudStack>
</MudPaper>

@* Data Grid Section *@
<MudPaper Elevation="1" Class="pa-0">
    <MudDataGrid @ref="_dataGrid"
                 T="LetterAgreementViewModel"
                 ServerData="LoadServerData"
                 Filterable="true"
                 FilterMode="DataGridFilterMode.ColumnFilterRow"
                 SortMode="SortMode.Multiple"
                 Groupable="false"
                 Hover="true"
                 Dense="true"
                 FixedHeader="true"
                 Height="calc(100vh - 280px)"
                 RowClick="@OnRowClick"
                 RowStyleFunc="@RowStyleFunc"
                 ColumnResizeMode="ResizeMode.Column">
        <ToolBarContent>
            <MudStack Row="true" Spacing="1" Class="flex-wrap">
                <MudTooltip Text="Add New Letter Agreement">
                    <MudIconButton Icon="@Icons.Material.Filled.Add" 
                                   Color="Color.Primary" 
                                   OnClick="@AddNewLetterAgreement" />
                </MudTooltip>
                <MudTooltip Text="Edit Selected">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                   Color="Color.Default"
                                   Disabled="@(_selectedItem == null)"
                                   OnClick="@EditSelectedLetterAgreement" />
                </MudTooltip>
                <MudTooltip Text="Copy Selected">
                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" 
                                   Color="Color.Default"
                                   Disabled="@(_selectedItem == null)"
                                   OnClick="@CopySelectedLetterAgreement" />
                </MudTooltip>
                <MudTooltip Text="Delete Selected">
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                   Color="Color.Error"
                                   Disabled="@(_selectedItem == null)"
                                   OnClick="@DeleteSelectedLetterAgreement" />
                </MudTooltip>
                
                <MudDivider Vertical="true" FlexItem="true" Class="mx-2" />
                
                <MudTooltip Text="Export to Excel">
                    <MudIconButton Icon="@Icons.Material.Filled.FileDownload" 
                                   Color="Color.Success"
                                   OnClick="@ExportToExcel" />
                </MudTooltip>
                
                <MudDivider Vertical="true" FlexItem="true" Class="mx-2" />
                
                <MudTooltip Text="Column Visibility">
                    <MudIconButton Icon="@Icons.Material.Filled.ViewColumn" 
                                   Color="Color.Default"
                                   OnClick="@ToggleColumnChooser" />
                </MudTooltip>
            </MudStack>
            <MudSpacer />
            <MudText Typo="Typo.caption" Class="mr-4">
                Total: @_totalCount letter agreements
            </MudText>
        </ToolBarContent>
        
        <Columns>
            @* ========== ID Column (Visible) ========== *@
            <PropertyColumn Property="x => x.LetterAgreementID" Title="ID" 
                            Sortable="true" Filterable="true"
                            HeaderStyle="width: 90px;">
                <FooterTemplate>
                    Count: @_totalCount
                </FooterTemplate>
            </PropertyColumn>
            
            @* ========== Seller Information (Hidden by default) ========== *@
            <PropertyColumn Property="x => x.SellerLastName" Title="Seller Last Name"
                            Sortable="true" Filterable="true"
                            Hidden="@(!_columnVisibility.SellerLastName)" Hideable="true"
                            HeaderStyle="width: 180px;" />
            
            <PropertyColumn Property="x => x.SellerName" Title="Seller Name"
                            Sortable="true" Filterable="true"
                            Hidden="@(!_columnVisibility.SellerName)" Hideable="true"
                            HeaderStyle="width: 200px;" />
            
            <PropertyColumn Property="x => x.SellerEmail" Title="Seller Email"
                            Sortable="true" Filterable="true"
                            Hidden="@(!_columnVisibility.SellerEmail)" Hideable="true"
                            HeaderStyle="width: 200px;">
                <CellTemplate>
                    @if (!string.IsNullOrEmpty(context.Item.SellerEmail))
                    {
                        <MudLink Href="@($"mailto:{context.Item.SellerEmail}")" Target="_blank">
                            @context.Item.SellerEmail
                        </MudLink>
                    }
                </CellTemplate>
            </PropertyColumn>
            
            <PropertyColumn Property="x => x.SellerPhone" Title="Seller Phone"
                            Sortable="true" Filterable="true"
                            Hidden="@(!_columnVisibility.SellerPhone)" Hideable="true"
                            HeaderStyle="width: 120px;">
                <CellTemplate>
                    @if (!string.IsNullOrEmpty(context.Item.SellerPhone))
                    {
                        <MudLink Href="@($"tel:{context.Item.SellerPhone}")">
                            @context.Item.SellerPhone
                        </MudLink>
                    }
                </CellTemplate>
            </PropertyColumn>
            
            <PropertyColumn Property="x => x.SellerCity" Title="Seller City"
                            Sortable="true" Filterable="true"
                            Hidden="@(!_columnVisibility.SellerCity)" Hideable="true"
                            HeaderStyle="width: 170px;" />
            
            <PropertyColumn Property="x => x.SellerState" Title="Seller State"
                            Sortable="true" Filterable="true"
                            Hidden="@(!_columnVisibility.SellerState)" Hideable="true"
                            HeaderStyle="width: 80px;" />
            
            <PropertyColumn Property="x => x.SellerZipCode" Title="Seller Zip Code"
                            Sortable="true" Filterable="true"
                            Hidden="@(!_columnVisibility.SellerZipCode)" Hideable="true"
                            HeaderStyle="width: 100px;" />
            
            @* ========== Date Fields (Hidden by default) ========== *@
            <PropertyColumn Property="x => x.CreatedOn" Title="Created On"
                            Format="MM/dd/yyyy"
                            Sortable="true" Filterable="true"
                            Hidden="@(!_columnVisibility.CreatedOn)" Hideable="true"
                            HeaderStyle="width: 130px;" />
            
            <PropertyColumn Property="x => x.EffectiveDate" Title="Effective Date"
                            Format="MM/dd/yyyy"
                            Sortable="true" Filterable="true"
                            Hidden="@(!_columnVisibility.EffectiveDate)" Hideable="true"
                            HeaderStyle="width: 130px;" />
            
            @* ========== Banking Days (Visible) ========== *@
            <PropertyColumn Property="x => x.BankingDays" Title="Banking Days" 
                            Sortable="true" Filterable="true"
                            HeaderStyle="width: 130px;" />
            
            @* ========== Financial Fields (Hidden by default) ========== *@
            <PropertyColumn Property="x => x.TotalBonus" Title="Purchase Price"
                            Format="N2"
                            Sortable="true" Filterable="true"
                            Hidden="@(!_columnVisibility.TotalBonus)" Hideable="true"
                            HeaderStyle="width: 130px;"
                            CellStyle="text-align: right;" />
            
            <PropertyColumn Property="x => x.ConsiderationFee" Title="Consideration Fee"
                            Format="N2"
                            Sortable="true" Filterable="true"
                            Hidden="@(!_columnVisibility.ConsiderationFee)" Hideable="true"
                            HeaderStyle="width: 130px;"
                            CellStyle="text-align: right;" />
            
            <PropertyColumn Property="x => x.ReferralFee" Title="Referral Fee"
                            Format="N2"
                            Sortable="true" Filterable="true"
                            Hidden="@(!_columnVisibility.ReferralFee)" Hideable="true"
                            HeaderStyle="width: 130px;"
                            CellStyle="text-align: right;" />
            
            @* ========== Acreage Fields (Hidden by default) ========== *@
            <PropertyColumn Property="x => x.TotalGrossAcres" Title="Total Gross Acres"
                            Format="N4"
                            Sortable="true" Filterable="true"
                            Hidden="@(!_columnVisibility.TotalGrossAcres)" Hideable="true"
                            HeaderStyle="width: 140px;" />
            
            <PropertyColumn Property="x => x.TotalNetAcres" Title="Total Net Acres"
                            Format="N4"
                            Sortable="true" Filterable="true"
                            Hidden="@(!_columnVisibility.TotalNetAcres)" Hideable="true"
                            HeaderStyle="width: 140px;" />
            
            @* ========== Other Fields (Hidden by default) ========== *@
            <PropertyColumn Property="x => x.LandMan" Title="Land Man"
                            Sortable="true" Filterable="true"
                            Hidden="@(!_columnVisibility.LandMan)" Hideable="true"
                            HeaderStyle="width: 120px;" />
            
            <PropertyColumn Property="x => x.DealStatus" Title="Status"
                            Sortable="true" Filterable="true"
                            Hidden="@(!_columnVisibility.DealStatus)" Hideable="true"
                            HeaderStyle="width: 150px;" />
            
            @* ========== Acquisition ID (Visible) ========== *@
            <PropertyColumn Property="x => x.AcquisitionID" Title="Acq ID" 
                            Sortable="true" Filterable="true"
                            HeaderStyle="width: 90px;">
                <CellTemplate>
                    @if (context.Item.AcquisitionID.HasValue)
                    {
                        <MudLink Href="@($"/acquisition/edit/{context.Item.AcquisitionID}")" Color="Color.Primary">
                            @context.Item.AcquisitionID
                        </MudLink>
                    }
                </CellTemplate>
            </PropertyColumn>
            
            @* ========== Location/Unit Fields (Hidden by default) ========== *@
            <PropertyColumn Property="x => x.CountyName" Title="County Name"
                            Sortable="true" Filterable="true"
                            Hidden="@(!_columnVisibility.CountyName)" Hideable="true"
                            HeaderStyle="width: 175px;" />
            
            <PropertyColumn Property="x => x.OperatorName" Title="Operator Name"
                            Sortable="true" Filterable="true"
                            Hidden="@(!_columnVisibility.OperatorName)" Hideable="true"
                            HeaderStyle="width: 250px;" />
            
            <PropertyColumn Property="x => x.UnitName" Title="Unit Name"
                            Sortable="true" Filterable="true"
                            Hidden="@(!_columnVisibility.UnitName)" Hideable="true"
                            HeaderStyle="width: 350px;" />
            
        </Columns>
        
        <PagerContent>
            <MudDataGridPager T="LetterAgreementViewModel" 
                              PageSizeOptions="@(new int[] { 25, 50, 100, 250 })" />
        </PagerContent>
        
        <NoRecordsContent>
            <MudText Typo="Typo.body1">No letter agreements found.</MudText>
        </NoRecordsContent>
        
        <LoadingContent>
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
        </LoadingContent>
    </MudDataGrid>
</MudPaper>

@* Context Menu *@
<MudMenu @ref="_contextMenu" PositionAtCursor="true">
    <MudMenuItem Icon="@Icons.Material.Filled.Add" OnClick="@AddNewLetterAgreement">Add</MudMenuItem>
    <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="@EditSelectedLetterAgreement" Disabled="@(_selectedItem == null)">Edit</MudMenuItem>
    <MudMenuItem Icon="@Icons.Material.Filled.ContentCopy" OnClick="@CopySelectedLetterAgreement" Disabled="@(_selectedItem == null)">Copy</MudMenuItem>
    <MudMenuItem Icon="@Icons.Material.Filled.Delete" IconColor="Color.Error" OnClick="@DeleteSelectedLetterAgreement" Disabled="@(_selectedItem == null)">Delete</MudMenuItem>
</MudMenu>

@* Copy Confirmation Dialog *@
<MudDialog @bind-Visible="_showCopyDialog" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.ContentCopy" Class="mr-2" />
            Copy Letter Agreement
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (_selectedItem != null)
        {
            <MudText>Create a copy of this letter agreement?</MudText>
            <MudText Typo="Typo.body2" Class="mt-2">
                <strong>ID:</strong> @_selectedItem.LetterAgreementID
            </MudText>
            @if (!string.IsNullOrEmpty(_selectedItem.SellerName))
            {
                <MudText Typo="Typo.body2">
                    <strong>Seller:</strong> @_selectedItem.SellerName
                </MudText>
            }
            <MudAlert Severity="Severity.Info" Class="mt-3" Dense="true">
                The copy will have a new ID and the status will be set to "Draft".
            </MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _showCopyDialog = false)">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@ConfirmCopy">Copy</MudButton>
    </DialogActions>
</MudDialog>

@* Delete Confirmation Dialog *@
<MudDialog @bind-Visible="_showDeleteDialog" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Class="mr-2" />
            Confirm Delete
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (_selectedItem != null)
        {
            <MudText>Are you sure you want to delete this letter agreement?</MudText>
            <MudText Typo="Typo.body2" Class="mt-2">
                <strong>ID:</strong> @_selectedItem.LetterAgreementID
            </MudText>
            @if (!string.IsNullOrEmpty(_selectedItem.SellerName))
            {
                <MudText Typo="Typo.body2">
                    <strong>Seller:</strong> @_selectedItem.SellerName
                </MudText>
            }
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _showDeleteDialog = false)">Cancel</MudButton>
        <MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="@ConfirmDelete">Delete</MudButton>
    </DialogActions>
</MudDialog>

@* Column Chooser Dialog *@
<MudDialog @bind-Visible="_showColumnChooser" Options="@(new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.ViewColumn" Class="mr-2" />
            Column Visibility
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudText Typo="Typo.body2" Class="mb-3">Select which columns to display:</MudText>
        <MudGrid>
            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.subtitle2"><strong>Seller Info</strong></MudText>
                <MudCheckBox T="bool" Label="Seller Last Name" @bind-Value="_columnVisibility.SellerLastName" />
                <MudCheckBox T="bool" Label="Seller Name" @bind-Value="_columnVisibility.SellerName" />
                <MudCheckBox T="bool" Label="Seller Email" @bind-Value="_columnVisibility.SellerEmail" />
                <MudCheckBox T="bool" Label="Seller Phone" @bind-Value="_columnVisibility.SellerPhone" />
                <MudCheckBox T="bool" Label="Seller City" @bind-Value="_columnVisibility.SellerCity" />
                <MudCheckBox T="bool" Label="Seller State" @bind-Value="_columnVisibility.SellerState" />
                <MudCheckBox T="bool" Label="Seller Zip" @bind-Value="_columnVisibility.SellerZipCode" />
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.subtitle2"><strong>Dates & Financial</strong></MudText>
                <MudCheckBox T="bool" Label="Created On" @bind-Value="_columnVisibility.CreatedOn" />
                <MudCheckBox T="bool" Label="Effective Date" @bind-Value="_columnVisibility.EffectiveDate" />
                <MudCheckBox T="bool" Label="Purchase Price" @bind-Value="_columnVisibility.TotalBonus" />
                <MudCheckBox T="bool" Label="Consideration Fee" @bind-Value="_columnVisibility.ConsiderationFee" />
                <MudCheckBox T="bool" Label="Referral Fee" @bind-Value="_columnVisibility.ReferralFee" />
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.subtitle2"><strong>Location & Unit</strong></MudText>
                <MudCheckBox T="bool" Label="Land Man" @bind-Value="_columnVisibility.LandMan" />
                <MudCheckBox T="bool" Label="Status" @bind-Value="_columnVisibility.DealStatus" />
                <MudCheckBox T="bool" Label="County Name" @bind-Value="_columnVisibility.CountyName" />
                <MudCheckBox T="bool" Label="Operator Name" @bind-Value="_columnVisibility.OperatorName" />
                <MudCheckBox T="bool" Label="Unit Name" @bind-Value="_columnVisibility.UnitName" />
                <MudCheckBox T="bool" Label="Gross Acres" @bind-Value="_columnVisibility.TotalGrossAcres" />
                <MudCheckBox T="bool" Label="Net Acres" @bind-Value="_columnVisibility.TotalNetAcres" />
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@ResetColumnVisibility">Reset to Default</MudButton>
        <MudSpacer />
        <MudButton OnClick="@(() => _showColumnChooser = false)">Close</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@ApplyColumnVisibility">Apply</MudButton>
    </DialogActions>
</MudDialog>
