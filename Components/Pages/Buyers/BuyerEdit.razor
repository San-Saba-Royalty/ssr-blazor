@page "/buyer/edit/{BuyerId:int}"
@using SSRBusiness.Entities
@using SSRBlazor.Services
@using SSRBlazor.Components.Pages.Buyers
@inject BuyerService BuyerService
@inject BuyerContactService BuyerContactService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>Edit Buyer</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h5">Edit Buyer: @_buyer.BuyerName</MudText>
        <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.ArrowBack" Href="/buyers">Back to List</MudButton>
    </div>

    @if (_loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
            <MudTabPanel Text="Details">
                <MudForm Model="@_buyer" @ref="_form">
                    <MudGrid>
                        <MudItem xs="12">
                             <MudTextField @bind-Value="_buyer.BuyerName" Label="Buyer Name" Required="true" MaxLength="100" />
                        </MudItem>
                        
                        <MudItem xs="12">
                            <MudCheckBox @bind-Value="_buyer.DefaultBuyer" Label="Default Buyer" />
                        </MudItem>

                         <MudItem xs="12">
                            <MudNumericField @bind-Value="_buyer.DefaultCommission" 
                                           Label="Default Commission %" 
                                           Format="N2"
                                           Adornment="Adornment.End" 
                                           AdornmentText="%" />
                        </MudItem>

                        <MudItem xs="12">
                            <MudDivider Class="my-4" />
                            <MudText Typo="Typo.h6">Primary Contact Info</MudText>
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_buyer.ContactName" Label="Contact Name" MaxLength="100" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_buyer.Attention" Label="Attention" MaxLength="50" />
                        </MudItem>

                        <MudItem xs="12" sm="4">
                             <MudTextField @bind-Value="_buyer.ContactPhone" Label="Phone" MaxLength="50" />
                        </MudItem>
                        <MudItem xs="12" sm="4">
                             <MudTextField @bind-Value="_buyer.ContactFax" Label="Fax" MaxLength="50" />
                        </MudItem>
                        <MudItem xs="12" sm="4">
                             <MudTextField @bind-Value="_buyer.ContactEmail" Label="Email" MaxLength="100" />
                        </MudItem>

                        <MudItem xs="12">
                             <MudTextField @bind-Value="_buyer.AddressLine1" Label="Address Line 1" MaxLength="100" />
                        </MudItem>
                        <MudItem xs="12">
                             <MudTextField @bind-Value="_buyer.AddressLine2" Label="Address Line 2" MaxLength="100" />
                        </MudItem>
                         <MudItem xs="12">
                             <MudTextField @bind-Value="_buyer.AddressLine3" Label="Address Line 3" MaxLength="100" />
                        </MudItem>

                        <MudItem xs="12" sm="6">
                             <MudTextField @bind-Value="_buyer.City" Label="City" MaxLength="50" />
                        </MudItem>
                        <MudItem xs="6" sm="3">
                             <MudTextField @bind-Value="_buyer.StateCode" Label="State" MaxLength="2" />
                        </MudItem>
                        <MudItem xs="6" sm="3">
                             <MudTextField @bind-Value="_buyer.ZipCode" Label="Zip" MaxLength="10" />
                        </MudItem>

                        <MudItem xs="12" Class="d-flex justify-end mt-4">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveBuyer">Save Changes</MudButton>
                        </MudItem>
                    </MudGrid>
                </MudForm>
            </MudTabPanel>
            
            <MudTabPanel Text="Contacts">
                <MudTable Items="@_contacts" Hover="true" Breakpoint="Breakpoint.Sm">
                    <ToolBarContent>
                        <MudText Typo="Typo.h6">Buyer Contacts</MudText>
                        <MudSpacer />
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AddContact">Add Contact</MudButton>
                    </ToolBarContent>
                    <HeaderContent>
                        <MudTh>Name</MudTh>
                        <MudTh>Email</MudTh>
                        <MudTh>Phone</MudTh>
                        <MudTh>City</MudTh>
                        <MudTh>State</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Name">@context.ContactName</MudTd>
                        <MudTd DataLabel="Email">@context.ContactEmail</MudTd>
                        <MudTd DataLabel="Phone">@context.ContactPhone</MudTd>
                        <MudTd DataLabel="City">@context.City</MudTd>
                        <MudTd DataLabel="State">@context.StateCode</MudTd>
                        <MudTd DataLabel="Actions">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(() => EditContact(context))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteContact(context))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudTabPanel>
        </MudTabs>
    }
</MudContainer>

@code {
    [Parameter] public int BuyerId { get; set; }

    private Buyer _buyer = new();
    private List<BuyerContact> _contacts = new();
    private bool _loading = true;
    private MudForm _form = default!;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        try 
        {
            var buyer = await BuyerService.GetByIdAsync(BuyerId);
            if (buyer == null)
            {
                Snackbar.Add("Buyer not found", Severity.Error);
                NavigationManager.NavigateTo("/buyers");
                return;
            }
            _buyer = buyer;
            _contacts = await BuyerContactService.GetByBuyerIdAsync(BuyerId);
        }
        catch (Exception ex)
        {
             Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task SaveBuyer()
    {
        await _form.Validate();
        if (_form.IsValid)
        {
            try
            {
                await BuyerService.UpdateAsync(_buyer);
                Snackbar.Add("Buyer updated", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error updating buyer: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task AddContact()
    {
        var parameters = new DialogParameters();
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<BuyerContactDialog>("Add Contact", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is BuyerContact newContact)
        {
            newContact.BuyerID = BuyerId; // Ensure link
            try
            {
                await BuyerContactService.AddAsync(newContact);
                Snackbar.Add("Contact added", Severity.Success);
                // Reload contacts
                _contacts = await BuyerContactService.GetByBuyerIdAsync(BuyerId);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error adding contact: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task EditContact(BuyerContact contact)
    {
        var parameters = new DialogParameters { ["Contact"] = contact };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<BuyerContactDialog>("Edit Contact", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is BuyerContact updatedContact)
        {
            try
            {
                await BuyerContactService.UpdateAsync(updatedContact);
                Snackbar.Add("Contact updated", Severity.Success);
                 _contacts = await BuyerContactService.GetByBuyerIdAsync(BuyerId);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error updating contact: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteContact(BuyerContact contact)
    {
        bool? confirmed = await DialogService.ShowMessageBox(
           "Warning", 
           $"Are you sure you want to delete contact '{contact.ContactName}'?", 
           yesText: "Delete", cancelText: "Cancel");

        if (confirmed == true)
        {
            try
            {
                await BuyerContactService.DeleteAsync(contact.BuyerContactID);
                Snackbar.Add("Contact deleted", Severity.Success);
                _contacts.Remove(contact); // Optimistic UI update or reload
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting contact: {ex.Message}", Severity.Error);
            }
        }
    }
}
