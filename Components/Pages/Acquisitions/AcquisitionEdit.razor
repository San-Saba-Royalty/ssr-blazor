@page "/acquisition/edit/{AcquisitionId:int}"
@page "/acquisitions/add"
@page "/Acquisition/AcquisitionEdit"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using SSRBusiness.BusinessClasses
@using SSRBusiness.BusinessFramework
@using SSRBusiness.Entities
@using SSRBlazor.Services

@using MudBlazor
@attribute [Authorize]
@inject AcquisitionRepository AcquisitionRepo
@inject NavigationManager navManager
@inject ISnackbar Snackbar
@inject ISpreadsheetImportService SpreadsheetService
@inject AuthenticationStateProvider AuthenticationStateProvider

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h5" GutterBottom="true">Acquisition Entry</MudText>

    @if (_loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (_acquisition != null)
    {
        <!-- Persistent Header Panel -->
        <MudPaper Class="pa-4 mb-4" Elevation="3">
            <MudGrid>
                <MudItem xs="6" sm="3">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Acquisition #</MudText>
                    <MudText Typo="Typo.h6">@_acquisition.AcquisitionNumber</MudText>
                </MudItem>
                <MudItem xs="6" sm="3">
                     <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Status</MudText>
                     <MudText Typo="Typo.h6">@GetDealStatusString()</MudText>
                </MudItem>
                <MudItem xs="6" sm="3">
                     <MudText Typo="Typo.subtitle2" Color="Color.Secondary">SSR In Pay</MudText>
                     <MudText Typo="Typo.h6">@_acquisition.SsrInPay</MudText>
                </MudItem>
                <MudItem xs="6" sm="3">
                     <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Net Acres</MudText>
                     <MudText Typo="Typo.h6">@_acquisition.TotalNetAcres?.ToString("N4")</MudText>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <EditForm Model="@_acquisition" OnValidSubmit="SaveAcquisition">
            <DataAnnotationsValidator />
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
                
                <!-- Tab 1: Acquisition Information -->
                <MudTabPanel Text="Acquisition Information">
                    <MudExpansionPanels MultiExpansion="true">
                        
                         <!-- Seller Information -->
                        <MudExpansionPanel Text="Seller Information" Expanded="true">
                            <MudGrid>
                                 <MudItem xs="12">
                                     <MudTable Items="_acquisition.AcquisitionSellers" Dense="true" Hover="true">
                                         <HeaderContent>
                                             <MudTh>Seller Name</MudTh>
                                             <MudTh>City</MudTh>
                                             <MudTh>State</MudTh>
                                             <MudTh>Actions</MudTh>
                                         </HeaderContent>
                                         <RowTemplate Context="sellerCtx">
                                             <MudTd>@sellerCtx.SellerName</MudTd>
                                             <MudTd>@sellerCtx.City</MudTd>
                                             <MudTd>@sellerCtx.StateCode</MudTd>
                                             <MudTd>
                                                 <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => EditSeller(sellerCtx))">Edit</MudButton>
                                             </MudTd>
                                         </RowTemplate>
                                     </MudTable>
                                     <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Secondary" Class="mt-2" OnClick="AddSeller">Add Seller</MudButton>
                                 </MudItem>
                            </MudGrid>
                        </MudExpansionPanel>

                        <!-- Deed and Draft Information -->
                        <MudExpansionPanel Text="Deed and Draft Information" Expanded="true">
                            <MudGrid>
                                <!-- Dates -->
                                <MudItem xs="12" md="6">
                                    <MudCard Elevation="0">
                                        <MudCardContent>
                                            <MudGrid>
                                                <MudItem xs="6">
                                                    <MudDatePicker Label="Effective Date" @bind-Date="_acquisition.EffectiveDate" />
                                                </MudItem>
                                                 <MudItem xs="6">
                                                    <MudDatePicker Label="Buyer Effective Date" @bind-Date="_acquisition.BuyerEffectiveDate" />
                                                </MudItem>
                                                 <MudItem xs="6">
                                                    <MudDatePicker Label="Due Date" @bind-Date="_acquisition.DueDate" />
                                                </MudItem>
                                                 <MudItem xs="6">
                                                    <MudDatePicker Label="Paid Date" @bind-Date="_acquisition.PaidDate" />
                                                </MudItem>
                                            </MudGrid>
                                        </MudCardContent>
                                    </MudCard>
                                </MudItem>
                                
                                <!-- Financials -->
                                <MudItem xs="12" md="6">
                                    <MudGrid>
                                        <MudItem xs="6">
                                           <MudNumericField Value="@_acquisition.TotalBonus" ValueChanged="@((decimal? v) => { _acquisition.TotalBonus = v; CalculateFinancials(); })" Label="Total Bonus" Format="C2" Variant="Variant.Outlined" />
                                        </MudItem>
                                        <MudItem xs="6">
                                           <MudNumericField Value="@_acquisition.DraftFee" ValueChanged="@((decimal? v) => { _acquisition.DraftFee = v; CalculateFinancials(); })" Label="Draft Fee" Format="C2" Variant="Variant.Outlined" />
                                        </MudItem>
                                        <MudItem xs="6">
                                             <MudNumericField Value="@_acquisition.ConsiderationFee" ValueChanged="@((decimal? v) => { _acquisition.ConsiderationFee = v; CalculateFinancials(); })" Label="Consideration Fee" Format="C2" Variant="Variant.Outlined" />
                                        </MudItem>
                                        <MudItem xs="6">
                                             <MudCheckBox Value="@_acquisition.TakeConsiderationFromTotal" ValueChanged="@((bool v) => { _acquisition.TakeConsiderationFromTotal = v; CalculateFinancials(); })" Label="Take Cons. from Total" />
                                        </MudItem>
                                        <MudItem xs="12">
                                             <MudNumericField Value="@_acquisition.TotalBonusAndFee" Label="Total Bonus and Fee (Calculated)" Format="C2" Variant="Variant.Filled" ReadOnly="true" />
                                        </MudItem>
                                        <MudItem xs="6">
                                             <MudNumericField Value="@_acquisition.TaxAmountDue" Label="Tax Amount Due" Format="C2" Variant="Variant.Outlined" />
                                        </MudItem>
                                        <MudItem xs="6">
                                             <MudNumericField Value="@_acquisition.TaxAmountPaid" ValueChanged="@((decimal? v) => { _acquisition.TaxAmountPaid = v; CalculateFinancials(); })" Label="Tax Amount Paid" Format="C2" Variant="Variant.Outlined" />
                                        </MudItem>
                                         <MudItem xs="6">
                                             <MudCheckBox Value="@_acquisition.TaxesDue" ValueChanged="@((bool v) => { _acquisition.TaxesDue = v; CalculateFinancials(); })" Label="Taxes Due" />
                                        </MudItem>
                                    </MudGrid>
                                </MudItem>
                            </MudGrid>
                        </MudExpansionPanel>

                        <!-- Title Information -->
                        <MudExpansionPanel Text="Title Information">
                            <MudGrid>
                                <MudItem xs="12" md="6">
                                    <MudCheckBox @bind-Value="_acquisition.FieldCheck" Label="Field Check" />
                                     <MudCheckBox @bind-Value="_acquisition.Liens" Label="Liens" />
                                     <MudTextField @bind-Value="_acquisition.ClosingStatus" Label="Closing Status" />
                                </MudItem>
                                
                                <MudItem xs="12">
                                    <MudDivider Class="my-2"/>
                                    <MudText Typo="Typo.subtitle1">Referrals</MudText>
                                    <MudGrid>
                                        <MudItem xs="12" sm="6">
                                             <MudNumericField Value="@_acquisition.ReferralFee" ValueChanged="@((decimal? v) => { _acquisition.ReferralFee = v; CalculateFinancials(); })" Label="Referral Fee" Format="C2" Variant="Variant.Outlined" ReadOnly="@(_totalReferralPercent > 0)" HelperText="@(_totalReferralPercent > 0 ? "Calculated from Percent" : "Manual Entry")" />
                                        </MudItem>
                                        <MudItem xs="12" sm="6">
                                             <MudSelect T="string" Label="Who Pays Referral" Value="@_acquisition.WhoPaysReferral" ValueChanged="@((string v) => { _acquisition.WhoPaysReferral = v; CalculateFinancials(); })" Variant="Variant.Outlined" Margin="Margin.Dense">
                                                <MudSelectItem Value="@("S")">Seller</MudSelectItem>
                                                <MudSelectItem Value="@("B")">Buyer</MudSelectItem>
                                            </MudSelect>
                                        </MudItem>
                                    </MudGrid>
                                     <MudTable Items="@_acquisition.AcquisitionReferrers" Dense="true" Elevation="0">
                                        <HeaderContent>
                                            <MudTh>Referrer</MudTh>
                                            <MudTh>Percent</MudTh>
                                            <MudTh>Amount</MudTh>
                                            <MudTh>Actions</MudTh>
                                        </HeaderContent>
                                        <RowTemplate Context="referrerCtx">
                                            <MudTd>@(referrerCtx.Referrer?.ReferrerName)</MudTd>
                                            <MudTd>@referrerCtx.ReferralPercent</MudTd>
                                            <MudTd>@referrerCtx.ReferralAmount?.ToString("C")</MudTd>
                                            <MudTd>
                                                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => EditReferrer(referrerCtx))">Edit</MudButton>
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                    <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Secondary" Class="mt-2" OnClick="AddReferrer">Add Referrer</MudButton>
                                </MudItem>

                                <MudItem xs="12">
                                     <MudDivider Class="my-2"/>
                                     <MudText Typo="Typo.subtitle1">Liens</MudText>
                                     <MudTable Items="@_acquisition.AcquisitionLiens" Dense="true" Elevation="0">
                                        <HeaderContent>
                                            <MudTh>Holder</MudTh>
                                            <MudTh>Type</MudTh>
                                            <MudTh>Amount</MudTh>
                                            <MudTh>Actions</MudTh>
                                        </HeaderContent>
                                        <RowTemplate Context="lienCtx">
                                            <MudTd>@lienCtx.LienHolder</MudTd>
                                            <MudTd>@(lienCtx.LienType?.LienTypeName)</MudTd>
                                            <MudTd>@lienCtx.PayoffAmount?.ToString("C")</MudTd>
                                            <MudTd>
                                                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => EditLien(lienCtx))">Edit</MudButton>
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                     <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Secondary" Class="mt-2" OnClick="AddLien">Add Lien</MudButton>
                                </MudItem>
                                
                                <MudItem xs="12">
                                     <MudDivider Class="my-2"/>
                                     <MudText Typo="Typo.subtitle1">Curative Requirements</MudText>
                                     <MudTable Items="@_acquisition.AcqCurativeRequirements" Dense="true" Elevation="0">
                                        <HeaderContent>
                                            <MudTh>Type</MudTh>
                                            <MudTh>Notes</MudTh>
                                            <MudTh>Completed</MudTh>
                                            <MudTh>Actions</MudTh>
                                        </HeaderContent>
                                        <RowTemplate Context="curativeCtx">
                                            <MudTd>@(curativeCtx.CurativeType?.CurativeTypeName)</MudTd>
                                            <MudTd>@curativeCtx.Notes</MudTd>
                                            <MudTd>@(curativeCtx.CompletedDate.HasValue ? curativeCtx.CompletedDate.Value.ToShortDateString() : "")</MudTd>
                                            <MudTd>
                                                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => EditCurative(curativeCtx))">Edit</MudButton>
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                    <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Secondary" Class="mt-2" OnClick="AddCurative">Add Requirement</MudButton>
                                </MudItem>
                            </MudGrid>
                        </MudExpansionPanel>
                        
                        <!-- Buyer Information -->
                        <MudExpansionPanel Text="Buyer Information">
                             <MudDataGrid Items="@_acquisition.AcquisitionBuyers" Dense="true" Hover="true" Bordered="true" Striped="true">
                                <ToolBarContent>
                                    <MudText Typo="Typo.h6">Buyers</MudText>
                                    <MudSpacer />
                                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AddBuyer">Add Buyer</MudButton>
                                </ToolBarContent>
                                <Columns>
                                    <PropertyColumn Property="x => x.Buyer.BuyerName" Title="Buyer Name" />
                                     <!-- Add more columns if useful, e.g. Assignee, EffectiveDate logic? -->
                                    <TemplateColumn CellClass="d-flex justify-end">
                                        <CellTemplate Context="buyerCtx">
                                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(() => EditBuyer(buyerCtx.Item))" />
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => RemoveBuyer(buyerCtx.Item))" />
                                        </CellTemplate>
                                    </TemplateColumn>
                                </Columns>
                            </MudDataGrid>
                        </MudExpansionPanel>

                        <!-- Invoicing -->
                        <MudExpansionPanel Text="Invoicing">
                            <MudGrid>
                                <MudItem xs="6" sm="3">
                                     <MudTextField @bind-Value="_acquisition.InvoiceNumber" Label="Invoice #" />
                                </MudItem>
                                <MudItem xs="6" sm="3">
                                     <MudDatePicker Label="Invoice Date" @bind-Date="_acquisition.InvoiceDate" />
                                </MudItem>
                                <MudItem xs="6" sm="3">
                                     <MudNumericField Value="@_acquisition.InvoiceTotal" Label="Invoice Total" Format="C2" ReadOnly="@_acquisition.AutoCalculateInvoice" />
                                </MudItem>
                                <MudItem xs="6" sm="3">
                                     <MudCheckBox Value="@_acquisition.AutoCalculateInvoice" ValueChanged="@((bool v) => { _acquisition.AutoCalculateInvoice = v; CalculateFinancials(); })" Label="Auto Calculate" />
                                </MudItem>
                                 <MudItem xs="6" sm="3">
                                     <MudNumericField Value="@_acquisition.CommissionPercent" ValueChanged="@((decimal? v) => { _acquisition.CommissionPercent = v; CalculateFinancials(); })" Label="Commission %" Format="N2" />
                                </MudItem>
                                <MudItem xs="6" sm="3">
                                     <MudNumericField Value="@_acquisition.Commission" Label="Commission" Format="C2" ReadOnly="@_acquisition.AutoCalculateInvoice" />
                                </MudItem>
                            </MudGrid>
                        </MudExpansionPanel>

                         <!-- Property Information and Notifications -->
                         <MudExpansionPanel Text="Property Information and Notifications">
                             <MudTabs Elevation="0" Outlined="true" PanelClass="pa-2">
                                 <MudTabPanel Text="Property Setup">
                                     <!-- Counties -->
                                     <MudText Typo="Typo.h6" Class="mt-2">Counties</MudText>
                                     <MudTable Items="_acquisition.AcquisitionCounties" Dense="true">
                                        <HeaderContent>
                                            <MudTh>County</MudTh>
                                            <MudTh>Rec Fee</MudTh>
                                            <MudTh>Actions</MudTh>
                                        </HeaderContent>
                                        <RowTemplate Context="countyCtx">
                                            <MudTd>@(countyCtx.County?.CountyName ?? countyCtx.CountyID.ToString())</MudTd>
                                            <MudTd>@countyCtx.County?.RecordingFeeFirstPage</MudTd>
                                            <MudTd>
                                                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => EditCounty(countyCtx))">Edit</MudButton>
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                    <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Secondary" Class="mt-2" OnClick="AddCounty">Add County</MudButton>
                                    
                                    <!-- Operators -->
                                     <MudText Typo="Typo.h6" Class="mt-4">Operators</MudText>
                                     <MudTable Items="_acquisition.AcquisitionOperators" Dense="true">
                                        <HeaderContent>
                                            <MudTh>Operator</MudTh>
                                            <MudTh>Actions</MudTh>
                                        </HeaderContent>
                                        <RowTemplate Context="operatorCtx">
                                            <MudTd>@(operatorCtx.Operator?.OperatorName ?? operatorCtx.OperatorID.ToString())</MudTd>
                                            <MudTd>
                                                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => EditOperator(operatorCtx))">Edit</MudButton>
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                    <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Secondary" Class="mt-2" OnClick="AddOperator">Add Operator</MudButton>
                                 </MudTabPanel>
                                 <MudTabPanel Text="Property Information">
                                     <!-- Units Grid -->
                                     <MudText Typo="Typo.h6">Acquisition Units</MudText>
                                     <MudTable Items="_acquisition.AcquisitionUnits" Dense="true">
                                         <HeaderContent>
                                             <MudTh>Unit Name</MudTh>
                                             <MudTh>Type</MudTh>
                                             <MudTh>Gross Acres</MudTh>
                                             <MudTh>Net Acres</MudTh>
                                             <MudTh>Interest</MudTh>
                                             <MudTh>Actions</MudTh>
                                         </HeaderContent>
                                         <RowTemplate Context="unitCtx">
                                             <MudTd>@unitCtx.UnitName</MudTd>
                                             <MudTd>@(unitCtx.UnitType?.UnitTypeDesc)</MudTd>
                                             <MudTd>@unitCtx.GrossAcres?.ToString("N4")</MudTd>
                                             <MudTd>@unitCtx.NetAcres?.ToString("N4")</MudTd>
                                             <MudTd>@unitCtx.UnitInterest?.ToString("N8")</MudTd>
                                             <MudTd>
                                                 <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => EditUnit(unitCtx))">Edit</MudButton>
                                             </MudTd>
                                         </RowTemplate>
                                     </MudTable>
                                     <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Secondary" Class="mt-2" OnClick="AddUnit">Add Unit</MudButton>
                                 </MudTabPanel>
                             </MudTabs>
                         </MudExpansionPanel>

                         <!-- Copy From Spreadsheet -->
                         <MudExpansionPanel Text="Copy From Spreadsheet">
                             <MudGrid>
                                <MudItem xs="12">
                                    <MudTextField @bind-Value="_spreadsheetData" Label="Paste Data (Tab Separated)" Variant="Variant.Outlined" Lines="5" />
                                </MudItem>
                                <MudItem xs="12">
                                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ImportSpreadsheet" Disabled="@_isImporting">Import</MudButton>
                                     @if (_importResult != null)
                                     {
                                         if (_importResult.Success)
                                         {
                                             <MudAlert Severity="Severity.Success" Class="mt-2">Import Successful!</MudAlert>
                                         }
                                         else
                                         {
                                             <MudAlert Severity="Severity.Error" Class="mt-2">
                                                 <MudText>Import Failed:</MudText>
                                                 <ul>
                                                     @foreach (var err in _importResult.Errors)
                                                     {
                                                         <li>@err</li>
                                                     }
                                                 </ul>
                                             </MudAlert>
                                         }
                                     }
                                </MudItem>
                            </MudGrid>
                         </MudExpansionPanel>
                         
                    </MudExpansionPanels>
                </MudTabPanel>

                <!-- Tab 2: Notes -->
                <MudTabPanel Text="Notes">
                    <AcquisitionNotes AcquisitionId="@(_acquisition.AcquisitionID)" />
                </MudTabPanel>

                <!-- Tab 3: Documents -->
                <MudTabPanel Text="Documents">
                    @if (_acquisition.AcquisitionID > 0)
                    {
                        <AcquisitionDocuments AcquisitionId="@_acquisition.AcquisitionID" ShowTabs="false" />
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">Please save the acquisition before managing documents.</MudAlert>
                    }
                </MudTabPanel>

                <!-- Tab 4: Audit History -->
                <MudTabPanel Text="Audit History">
                    <AcquisitionAuditHistory AcquisitionId="@(_acquisition.AcquisitionID)" />
                </MudTabPanel>
            </MudTabs>
            
            <div class="d-flex justify-start mt-4">
                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="mr-2">Save</MudButton>
                <MudButton OnClick="Cancel" Variant="Variant.Outlined" Color="Color.Secondary">Cancel</MudButton>
            </div>
            
        </EditForm>
    }
</MudContainer>


@code {
    [Parameter] public int? AcquisitionId { get; set; }

    private Acquisition? _acquisition;
    private string _spreadsheetData = "";
    private bool _isImporting = false;
    private ImportResult? _importResult;
    
    // ... (rest of existing fields)
    
    private async Task ImportSpreadsheet()
    {
        if (_acquisition == null) return;
        
        _isImporting = true;
        _importResult = null;
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.Identity?.Name ?? "Unknown";

            _importResult = await SpreadsheetService.ImportDataAsync(_spreadsheetData, _acquisition.AcquisitionID, userId);
            
            if (_importResult.Success)
            {
                 Snackbar.Add("Import successful", Severity.Success);
                 _spreadsheetData = ""; // Clear input
                 // Reload to show changes
                 await LoadAcquisition(); 
            }
            else
            {
                Snackbar.Add("Import failed with errors", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _importResult = new ImportResult { Success = false, Errors = new List<string> { ex.Message } };
            Snackbar.Add($"Import exception: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isImporting = false;
        }
    }

    private async Task LoadAcquisition()
    {
         if (AcquisitionId.HasValue)
         {
             _acquisition = await AcquisitionRepo.LoadAcquisitionByAcquisitionIDAsync(AcquisitionId.Value);
         }
         else
         {
             // Handle new acquisition or error
         }
         StateHasChanged();
    }
    private bool _loading = true;
    private List<User> _landmen = new();
    private List<County> _counties = new();
    private List<Operator> _operators = new();
    private List<UnitType> _unitTypes = new();
    private List<FolderLocation> _folderLocations = new();
    private List<Referrer> _referrers = new();
    private List<LienType> _lienTypes = new();
    private List<CurativeType> _curativeTypes = new();
    
    [Inject] IDialogService DialogService { get; set; } = default!;
    
    [Inject] UserRepository UserRepo { get; set; } = default!;
    [Inject] StateRepository StateRepo { get; set; } = default!;
    [Inject] CountyRepository CountyRepo { get; set; } = default!;
    [Inject] OperatorRepository OperatorRepo { get; set; } = default!;
    [Inject] Repository<UnitType> UnitTypeRepo { get; set; } = default!;
    [Inject] Repository<FolderLocation> FolderLocationRepo { get; set; } = default!;
    [Inject] Repository<Referrer> ReferrerRepo { get; set; } = default!;
    [Inject] Repository<LienType> LienTypeRepo { get; set; } = default!;
    [Inject] Repository<CurativeType> CurativeTypeRepo { get; set; } = default!;
    private decimal _totalReferralPercent = 0;

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            _loading = true;
            // Load Lookups - load each async but don't use Task.WhenAll due to mixed types
            _landmen = (await UserRepo.GetAllAsync()).OrderBy(u => u.LastName).ToList();
            _counties = (await CountyRepo.GetCountiesAsync().ToListAsync()).OrderBy(c => c.CountyName).ToList();
            _operators = (await OperatorRepo.GetOperatorsAsync().ToListAsync()).OrderBy(o => o.OperatorName).ToList();
            _unitTypes = (await UnitTypeRepo.GetAllAsync()).OrderBy(t => t.UnitTypeDesc).ToList();
            _folderLocations = (await FolderLocationRepo.GetAllAsync()).OrderBy(f => f.FolderLocationText).ToList();
            _referrers = (await ReferrerRepo.GetAllAsync()).OrderBy(r => r.ReferrerName).ToList();
            _lienTypes = (await LienTypeRepo.GetAllAsync()).OrderBy(l => l.LienTypeName).ToList();
            _curativeTypes = (await CurativeTypeRepo.GetAllAsync()).OrderBy(c => c.CurativeTypeName).ToList();
            
            if (AcquisitionId.HasValue)
            {
                _acquisition = await AcquisitionRepo.LoadAcquisitionByAcquisitionIDAsync(AcquisitionId.Value);
                if (_acquisition != null && _acquisition.AcquisitionReferrers != null)
                {
                    _totalReferralPercent = _acquisition.AcquisitionReferrers.Sum(r => r.ReferralPercent ?? 0);
                }
            }
            else
            {
                _acquisition = new Acquisition();
                _acquisition.EffectiveDate = DateTime.Today;
                _acquisition.AcquisitionSellers = new List<AcquisitionSeller>(); 
                _acquisition.AcquisitionCounties = new List<AcquisitionCounty>();
                _acquisition.AcquisitionOperators = new List<AcquisitionOperator>();
                _acquisition.AcquisitionUnits = new List<AcquisitionUnit>();
                _acquisition.AcquisitionReferrers = new List<AcquisitionReferrer>();
                _acquisition.AcquisitionLiens = new List<AcquisitionLien>();
                _acquisition.AcqCurativeRequirements = new List<AcqCurativeRequirement>();
            }
        }
        catch (Exception ex)
        {
             Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void CalculateFinancials()
    {
        if (_acquisition == null) return;

        decimal totalBonus = _acquisition.TotalBonus ?? 0;
        decimal considerationFee = _acquisition.ConsiderationFee ?? 0;
        decimal taxAmountPaid = _acquisition.TaxAmountPaid ?? 0;
        decimal referralFee = _acquisition.ReferralFee ?? 0;

        // Update Referral Fee if percent exists
        if (_totalReferralPercent > 0)
        {
            // Logic: referralFee = totalBonus * percent / 100
             referralFee = totalBonus * (_totalReferralPercent / 100m);
             _acquisition.ReferralFee = referralFee;
        }

        bool hasReferrer = _acquisition.AcquisitionReferrers != null && _acquisition.AcquisitionReferrers.Any();
        bool takeReferralFromSeller = hasReferrer && _acquisition.WhoPaysReferral == "S";
        bool buyerPaysReferral = hasReferrer && _acquisition.WhoPaysReferral == "B";

        // Calculate TotalBonusAndFee
        // Formula: TotalBonus - (TakeConsideration ? Consideration : 0) - TaxAmountPaid - (TakeReferralFromSeller ? ReferralFee : 0)
        
        decimal totalBonusAndFee = totalBonus;

        if (_acquisition.TakeConsiderationFromTotal)
        {
            totalBonusAndFee -= considerationFee;
        }

        totalBonusAndFee -= taxAmountPaid;

        if (takeReferralFromSeller)
        {
            totalBonusAndFee -= referralFee;
        }

        _acquisition.TotalBonusAndFee = totalBonusAndFee;

        // Invoice Logic
        if (_acquisition.AutoCalculateInvoice)
        {
            decimal bonusBase = totalBonus;
            if (buyerPaysReferral)
            {
                bonusBase += referralFee;
            }

            decimal commissionPercent = _acquisition.CommissionPercent ?? 0;
            decimal commission = bonusBase * (commissionPercent / 100m);

            _acquisition.Commission = commission;
            _acquisition.InvoiceTotal = bonusBase + commission;
        }
    }

    private void OnTotalBonusChanged(decimal? value)
    {
        if (_acquisition == null) return;
        _acquisition.TotalBonus = value;
        CalculateFinancials();
    }
    
    // Wrapper methods for other fields to ensuring triggering calc
    private void OnFinancialFieldChanged<T>(Action<T?> setter, T? value)
    {
        setter(value);
        CalculateFinancials();
    }
    
    // ... Save ... (Previous methods continue)
    
    // ... Save ...

    // ... Other Add Methods ...

    // Unit Methods
    private async Task AddUnit()
    {
        var acquisition = _acquisition;
        if (acquisition == null) return;

        var parameters = new DialogParameters<AcquisitionUnitDialog> 
        { 
            { x => x.AcqUnit, new AcquisitionUnit() },
            { x => x.UnitTypes, _unitTypes },
            { x => x.Counties, _counties }
        };
        var dialog = await DialogService.ShowAsync<AcquisitionUnitDialog>("Add Unit", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: AcquisitionUnit newItem })
        {
            newItem.AcquisitionID = acquisition.AcquisitionID;
            acquisition.AcquisitionUnits.Add(newItem);
            StateHasChanged();
        }
    }

    private async Task EditUnit(AcquisitionUnit item)
    {
        var parameters = new DialogParameters<AcquisitionUnitDialog> 
        { 
            { x => x.AcqUnit, item },
            { x => x.UnitTypes, _unitTypes },
            { x => x.Counties, _counties }
        };
        var dialog = await DialogService.ShowAsync<AcquisitionUnitDialog>("Edit Unit", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
             StateHasChanged();
        }
    }
    
    // ... SaveAcquisition and Cancel ...

    private async Task SaveAcquisition()
    {
        var acquisition = _acquisition;
        if (acquisition == null) return;
        
        try 
        {
            if (acquisition.AcquisitionID == 0)
            {
                await AcquisitionRepo.AddAsync(acquisition);
            }
            
            await AcquisitionRepo.SaveChangesAsync();
            
            Snackbar.Add("Acquisition saved successfully.", Severity.Success);
            navManager.NavigateTo("/acquisitions");
        }
        catch(Exception ex)
        {
            Snackbar.Add($"Error saving: {ex.Message}", Severity.Error);
        }
    }

    private async Task AddBuyer()
    {
        var existingBuyerIds = _acquisition?.AcquisitionBuyers.Select(ab => ab.BuyerID).ToList() ?? new List<int>();
        var parameters = new DialogParameters<AcquisitionAddBuyerDialog> 
        { 
            { x => x.ExcludeBuyerIds, existingBuyerIds } 
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        
        var dialog = await DialogService.ShowAsync<AcquisitionAddBuyerDialog>("Add Buyers", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is List<Buyer> selectedBuyers)
        {
            if (_acquisition != null)
            {
                foreach (var buyer in selectedBuyers)
                {
                    // Create new AcquisitionBuyer for each selected buyer
                    var newAcqBuyer = new AcquisitionBuyer
                    {
                        AcquisitionID = _acquisition.AcquisitionID,
                        BuyerID = buyer.BuyerID,
                        Buyer = buyer // Setting navigation prop for immediate display
                    };
                    
                    _acquisition.AcquisitionBuyers.Add(newAcqBuyer);
                }
                StateHasChanged();
            }
        }
    }

    private async Task EditBuyer(AcquisitionBuyer buyer)
    {
        var parameters = new DialogParameters<AcquisitionBuyerDialog> { { x => x.AcquisitionBuyer, buyer } };
        var dialog = await DialogService.ShowAsync<AcquisitionBuyerDialog>("Edit Buyer", parameters);
        var result = await dialog.Result;
        if (result is { Canceled: false }) StateHasChanged();
    }

    private async Task RemoveBuyer(AcquisitionBuyer buyer)
    {
        var confirm = await DialogService.ShowMessageBox("Warning", "Delete this buyer?", yesText:"Delete", cancelText:"Cancel");
        if (confirm == true)
        {
            _acquisition.AcquisitionBuyers.Remove(buyer);
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        navManager.NavigateTo("/acquisitions");
    }

    // ... Seller methods ...

    private async Task AddSeller()
    {
        var acquisition = _acquisition;
        if (acquisition == null) return;

        var parameters = new DialogParameters<AcquisitionSellerDialog> { { x => x.Seller, new AcquisitionSeller() } };
        var dialog = await DialogService.ShowAsync<AcquisitionSellerDialog>("Add Seller", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: AcquisitionSeller newSeller })
        {
            newSeller.AcquisitionID = acquisition.AcquisitionID;
            acquisition.AcquisitionSellers.Add(newSeller);
            StateHasChanged();
        }
    }

    private async Task EditSeller(AcquisitionSeller seller)
    {
        var parameters = new DialogParameters<AcquisitionSellerDialog> { { x => x.Seller, seller } };
        var dialog = await DialogService.ShowAsync<AcquisitionSellerDialog>("Edit Seller", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
             StateHasChanged();
        }
    }

    // County Methods
    private async Task AddCounty()
    {
        var acquisition = _acquisition;
        if (acquisition == null) return;

        var parameters = new DialogParameters<AcquisitionCountyDialog> 
        { 
            { x => x.AcqCounty, new AcquisitionCounty() },
            { x => x.Counties, _counties }
        };
        var dialog = await DialogService.ShowAsync<AcquisitionCountyDialog>("Add County", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: AcquisitionCounty newItem })
        {
            newItem.AcquisitionID = acquisition.AcquisitionID;
            acquisition.AcquisitionCounties.Add(newItem);
            StateHasChanged();
        }
    }

    private async Task EditCounty(AcquisitionCounty item)
    {
        var parameters = new DialogParameters<AcquisitionCountyDialog> 
        { 
            { x => x.AcqCounty, item },
            { x => x.Counties, _counties }
        };
        var dialog = await DialogService.ShowAsync<AcquisitionCountyDialog>("Edit County", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
             StateHasChanged();
        }
    }
    
    // Operator Methods
    private async Task AddOperator()
    {
        var acquisition = _acquisition;
        if (acquisition == null) return;

        var parameters = new DialogParameters<AcquisitionOperatorDialog> 
        { 
            { x => x.AcqOperator, new AcquisitionOperator() },
            { x => x.Operators, _operators }
        };
        var dialog = await DialogService.ShowAsync<AcquisitionOperatorDialog>("Add Operator", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: AcquisitionOperator newItem })
        {
            newItem.AcquisitionID = acquisition.AcquisitionID;
            acquisition.AcquisitionOperators.Add(newItem);
            StateHasChanged();
        }
    }

    private async Task EditOperator(AcquisitionOperator item)
    {
        var parameters = new DialogParameters<AcquisitionOperatorDialog> 
        { 
            { x => x.AcqOperator, item },
            { x => x.Operators, _operators }
        };
        var dialog = await DialogService.ShowAsync<AcquisitionOperatorDialog>("Edit Operator", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
             StateHasChanged();
        }
    }
    // Referrer Methods
    private async Task AddReferrer()
    {
        var acquisition = _acquisition;
        if (acquisition == null) return;

        var parameters = new DialogParameters<AcquisitionReferrerDialog> 
        { 
            { x => x.AcqReferrer, new AcquisitionReferrer() },
            { x => x.Referrers, _referrers }
        };
        var dialog = await DialogService.ShowAsync<AcquisitionReferrerDialog>("Add Referrer", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: AcquisitionReferrer newItem })
        {
            newItem.AcquisitionID = acquisition.AcquisitionID;
            acquisition.AcquisitionReferrers.Add(newItem);
            CalculateFinancials();
            StateHasChanged();
        }
    }
    
    private async Task EditReferrer(AcquisitionReferrer referrer)
    {
        var parameters = new DialogParameters<AcquisitionReferrerDialog> 
        { 
            { x => x.AcqReferrer, referrer },
            { x => x.Referrers, _referrers }
        };
        var dialog = await DialogService.ShowAsync<AcquisitionReferrerDialog>("Edit Referrer", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
             CalculateFinancials();
             StateHasChanged();
        }
    }

    // Lien Methods
    private async Task AddLien()
    {
         var acquisition = _acquisition;
         if (acquisition == null) return;

        var parameters = new DialogParameters<AcquisitionLienDialog> 
        { 
            { x => x.AcqLien, new AcquisitionLien() },
            { x => x.LienTypes, _lienTypes }
        };
        var dialog = await DialogService.ShowAsync<AcquisitionLienDialog>("Add Lien", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: AcquisitionLien newItem })
        {
            newItem.AcquisitionID = acquisition.AcquisitionID;
            acquisition.AcquisitionLiens.Add(newItem);
            StateHasChanged();
        }
    }

    private async Task EditLien(AcquisitionLien lien)
    {
        var parameters = new DialogParameters<AcquisitionLienDialog> 
        { 
            { x => x.AcqLien, lien },
            { x => x.LienTypes, _lienTypes }
        };
        var dialog = await DialogService.ShowAsync<AcquisitionLienDialog>("Edit Lien", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
             StateHasChanged();
        }
    }
    
    // Curative Methods
    private async Task AddCurative()
    {
        var acquisition = _acquisition;
        if (acquisition == null) return;

        var parameters = new DialogParameters<AcquisitionCurativeDialog> 
        { 
            { x => x.AcqRequirement, new AcqCurativeRequirement() },
            { x => x.CurativeTypes, _curativeTypes }
        };
        var dialog = await DialogService.ShowAsync<AcquisitionCurativeDialog>("Add Requirement", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: AcqCurativeRequirement newItem })
        {
            newItem.AcquisitionID = acquisition.AcquisitionID;
             acquisition.AcqCurativeRequirements.Add(newItem);
            StateHasChanged();
        }
    }

    private async Task EditCurative(AcqCurativeRequirement requirement)
    {
        var parameters = new DialogParameters<AcquisitionCurativeDialog> 
        { 
            { x => x.AcqRequirement, requirement },
            { x => x.CurativeTypes, _curativeTypes }
        };
        var dialog = await DialogService.ShowAsync<AcquisitionCurativeDialog>("Edit Requirement", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
             StateHasChanged();
        }
    }

    private string GetDealStatusString()
    {
        if (_acquisition == null || _acquisition.AcquisitionStatus == null || !_acquisition.AcquisitionStatus.Any())
            return "Active/Unknown"; 

        var latest = _acquisition.AcquisitionStatus
                        .OrderByDescending(s => s.StatusDate)
                        .FirstOrDefault();
        return latest?.DealStatus?.StatusName ?? "Unknown";
    }
}
