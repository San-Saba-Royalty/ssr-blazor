@page "/acquisitions"
@page "/acquisition/index"
@page "/Acquisition/AcquisitionIndex"

@using MudBlazor
@using SSRBusiness.Entities
@using SSRBlazor.Services

@using Microsoft.AspNetCore.Components.Authorization

@inject AcquisitionService AcquisitionService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject ViewService ViewService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject SessionStateService SessionStateService

<PageTitle>Mineral Acquisitions</PageTitle>

@* Messages Section *@
@if (!string.IsNullOrEmpty(_displayMessage))
{
    <MudAlert Severity="Severity.Info" Class="mb-2" ShowCloseIcon="true" CloseIconClicked="() => _displayMessage = string.Empty">
        @_displayMessage
    </MudAlert>
}

@if (_validationErrors.Any())
{
    <MudAlert Severity="Severity.Error" Class="mb-2" ShowCloseIcon="true" CloseIconClicked="() => _validationErrors.Clear()">
        <MudText Typo="Typo.subtitle2">The following errors were found:</MudText>
        <ul class="mb-0">
            @foreach (var error in _validationErrors)
            {
                <li>@error</li>
            }
        </ul>
    </MudAlert>
}

@* Header Section *@
<MudPaper Elevation="1" Class="pa-3 mb-3">
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3" Wrap="Wrap.Wrap">
        <MudText Typo="Typo.h6">Mineral Acquisitions</MudText>
        
        <MudButton Variant="Variant.Outlined" 
                   Color="Color.Primary" 
                   Size="Size.Small"
                   OnClick="@GotoLetterAgreements">
            Letter Agreements
        </MudButton>
        
        <MudDivider Vertical="true" FlexItem="true" />
        
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
            <MudText Typo="Typo.body2"><strong>Active Filter:</strong></MudText>
            <MudMenu Label="@_activeFilter" Variant="Variant.Outlined" Size="Size.Small" Color="Color.Info">
                @foreach (var filter in _availableFilters)
                {
                    <MudMenuItem OnClick="@(() => ApplyFilter(filter.Name))">
                        @if (filter.Name == _activeFilter)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Class="mr-2" />
                        }
                        @filter.Name
                    </MudMenuItem>
                }
            </MudMenu>
        </MudStack>
        
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
            <MudText Typo="Typo.body2"><strong>Active View:</strong></MudText>
            <MudMenu Label="@_activeView" Variant="Variant.Outlined" Size="Size.Small" Color="Color.Secondary">
                @foreach (var view in _availableViews)
                {
                    <MudMenuItem OnClick="@(() => OnViewSelected(view.ViewID))">
                        @if (view.ViewName == _activeView)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Class="mr-2" />
                        }
                        @view.ViewName
                    </MudMenuItem>
                }
                <MudDivider />
                <MudMenuItem OnClick="@(() => OnViewSelected(null))">Default View</MudMenuItem>
            </MudMenu>
        </MudStack>
        
        <MudSpacer />
        
        <MudButton Variant="Variant.Outlined" 
                   Size="Size.Small"
                   StartIcon="@Icons.Material.Filled.FilterAltOff"
                   OnClick="@ResetFilters">
            Reset Filters
        </MudButton>
        
        <MudButton Variant="Variant.Outlined" 
                   Size="Size.Small"
                   StartIcon="@Icons.Material.Filled.SortByAlpha"
                   OnClick="@ResetSort">
            Reset Sort
        </MudButton>
    </MudStack>
</MudPaper>

@* Data Grid Section *@
<MudPaper Elevation="1" Class="pa-0">
    <MudDataGrid @ref="_dataGrid"
                 T="Acquisition"
                 ServerData="LoadServerData"
                 Filterable="true"
                 FilterMode="DataGridFilterMode.ColumnFilterRow"
                 SortMode="SortMode.Multiple"
                 Groupable="false"
                 Hover="true"
                 Dense="true"
                 FixedHeader="true"
                 Height="calc(100vh - 280px)"
                 RowClick="@OnRowClick"
                 RowStyleFunc="@RowStyleFunc">
        <ToolBarContent>
            <MudStack Row="true" Spacing="1" Class="flex-wrap">
                <MudTooltip Text="Add New Acquisition">
                    <MudIconButton Icon="@Icons.Material.Filled.Add" 
                                   Color="Color.Primary" 
                                   OnClick="@AddNewAcquisition" />
                </MudTooltip>
                <MudTooltip Text="Edit Selected">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                   Color="Color.Default"
                                   Disabled="@(_selectedItem == null)"
                                   OnClick="@EditSelectedAcquisition" />
                </MudTooltip>
                <MudTooltip Text="Copy Selected">
                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" 
                                   Color="Color.Default"
                                   Disabled="@(_selectedItem == null)"
                                   OnClick="@CopySelectedAcquisition" />
                </MudTooltip>
                
                <MudTooltip Text="Go to Last Acquisition">
                    <MudIconButton Icon="@Icons.Material.Filled.History" 
                                   Color="Color.Secondary"
                                   OnClick="@GotoLastAcquisition" />
                </MudTooltip>
                <MudTooltip Text="Delete Selected">
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                   Color="Color.Error"
                                   Disabled="@(_selectedItem == null)"
                                   OnClick="@DeleteSelectedAcquisition" />
                </MudTooltip>
                
                <MudDivider Vertical="true" FlexItem="true" Class="mx-2" />
                
                <MudTooltip Text="Generate Barcode Cover Sheet">
                    <MudIconButton Icon="@Icons.Material.Filled.QrCode" 
                                   Color="Color.Default"
                                   Disabled="@(_selectedItem == null)"
                                   OnClick="@GenerateBarcodeCoverSheet" />
                </MudTooltip>
                
                <MudDivider Vertical="true" FlexItem="true" Class="mx-2" />
                
                <MudTooltip Text="Export to Excel">
                    <MudIconButton Icon="@Icons.Material.Filled.FileDownload" 
                                   Color="Color.Success"
                                   OnClick="@ExportToExcel" />
                </MudTooltip>
                
                <MudDivider Vertical="true" FlexItem="true" Class="mx-2" />

                <MudTooltip Text="Column Ordering">
                     <MudIconButton Icon="@Icons.Material.Filled.ViewColumn" 
                                    Color="Color.Default" 
                                    OnClick="@OpenColumnOrdering" />
                </MudTooltip>
            </MudStack>
            <MudSpacer />
            <MudText Typo="Typo.caption" Class="mr-4">
                Total: @_totalCount records
            </MudText>
        </ToolBarContent>
        
        <Columns>
            @* Always render AcquisitionID first if we want it pinned, or include in loop if dynamic *@
            @* We will check if "AcquisitionID" is in the ordered list. If not, we might want to force it or assume users can hide it. *@
            @* Logic: Iterate over _orderedVisibleColumns *@

            @foreach (var colName in _orderedVisibleColumns)
            {
                @GetColumnFragment(colName)
            }
        </Columns>

        <PagerContent>
            <MudDataGridPager T="Acquisition" 
                              PageSizeOptions="@(new int[] { 25, 50, 100, 250 })" />
        </PagerContent>
        
        <NoRecordsContent>
            <MudText Typo="Typo.body1">No acquisitions found matching the current filter.</MudText>
        </NoRecordsContent>
        
        <LoadingContent>
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
        </LoadingContent>
    </MudDataGrid>
</MudPaper>

@* Barcode Cover Sheet Dialog *@
<MudDialog @bind-Visible="_showBarcodeDialog" Options="@(new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">Generate Acquisition Cover Sheet</MudText>
    </TitleContent>
    <DialogContent>
        @if (_selectedItem != null)
        {
            <MudText>Generate barcode cover sheet for Acquisition ID: @_selectedItem.AcquisitionID</MudText>
            <MudText Typo="Typo.body2" Class="mt-2">Buyer: @_selectedItem.Buyer</MudText>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _showBarcodeDialog = false)">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@ConfirmGenerateBarcode">Generate</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private RenderFragment? GetColumnFragment(string columnName)
    {
        return columnName switch
        {
            // Note: T="Acquisition" is required because we are in a C# context now
            "AcquisitionID" or "Acq ID" => @<PropertyColumn T="Acquisition" TProperty="int" Property="x => x.AcquisitionID" Title="Acq ID" Sortable="true" Filterable="true" HeaderStyle="width: 90px;">
                <FooterTemplate>Count: @_totalCount</FooterTemplate>
            </PropertyColumn>,
            
            "Acquisition Number" => @<PropertyColumn T="Acquisition" TProperty="string" Property="x => x.AcquisitionNumber" Title="Acq Number" Sortable="true" Filterable="true" HeaderStyle="width: 120px;" />,
            
            "Buyer Name" => @<PropertyColumn T="Acquisition" TProperty="string" Property="x => x.Buyer" Title="Buyer" Sortable="true" Filterable="true" HeaderStyle="width: 180px;" />,
            
            "Assignee" => @<PropertyColumn T="Acquisition" TProperty="string" Property="x => x.Assignee" Title="Assignee" Sortable="true" Filterable="true" HeaderStyle="width: 150px;" />,
            
            "Folder Location" => @<PropertyColumn T="Acquisition" TProperty="string" Property="x => x.FolderLocation" Title="Folder Location" Sortable="true" Filterable="true" HeaderStyle="width: 180px;" />,
            
            "Effective Date" => @<PropertyColumn T="Acquisition" TProperty="DateTime?" Property="x => x.EffectiveDate" Title="Effective Date" Sortable="true" Filterable="true" Format="MM/dd/yyyy" HeaderStyle="width: 120px;" />,
            
            "Buyer Effective Date" => @<PropertyColumn T="Acquisition" TProperty="DateTime?" Property="x => x.BuyerEffectiveDate" Title="Buyer Eff. Date" Sortable="true" Filterable="true" Format="MM/dd/yyyy" HeaderStyle="width: 120px;" />,
            
            "Due Date" => @<PropertyColumn T="Acquisition" TProperty="DateTime?" Property="x => x.DueDate" Title="Due Date" Sortable="true" Filterable="true" Format="MM/dd/yyyy" HeaderStyle="width: 120px;" />,
            
            "Paid Date" => @<PropertyColumn T="Acquisition" TProperty="DateTime?" Property="x => x.PaidDate" Title="Paid Date" Sortable="true" Filterable="true" Format="MM/dd/yyyy" HeaderStyle="width: 120px;" />,
            
            "Total Bonus" => @<PropertyColumn T="Acquisition" TProperty="decimal?" Property="x => x.TotalBonus" Title="Total Bonus" Sortable="true" Filterable="true" Format="N2" HeaderStyle="width: 130px;" CellStyle="text-align: right;" />,
            
            "Consideration Fee" => @<PropertyColumn T="Acquisition" TProperty="decimal?" Property="x => x.ConsiderationFee" Title="Consideration Fee" Sortable="true" Filterable="true" Format="N2" HeaderStyle="width: 130px;" CellStyle="text-align: right;" />,
            
            "Total Bonus and Fee" => @<PropertyColumn T="Acquisition" TProperty="decimal?" Property="x => x.TotalBonusAndFee" Title="Total Bonus + Fee" Sortable="true" Filterable="true" Format="N2" HeaderStyle="width: 130px;" CellStyle="text-align: right;" />,
            
            "Draft Fee" => @<PropertyColumn T="Acquisition" TProperty="decimal?" Property="x => x.DraftFee" Title="Draft Fee" Sortable="true" Filterable="true" Format="N2" HeaderStyle="width: 120px;" CellStyle="text-align: right;" />,
            
            "Draft/Check Number" => @<PropertyColumn T="Acquisition" TProperty="string" Property="x => x.DraftCheckNumber" Title="Draft/Check #" Sortable="true" Filterable="true" HeaderStyle="width: 130px;" />,
            
            "Gross Acres" => @<PropertyColumn T="Acquisition" TProperty="decimal?" Property="x => x.TotalGrossAcres" Title="Gross Acres" Sortable="true" Filterable="true" Format="N4" HeaderStyle="width: 110px;" CellStyle="text-align: right;" />,
            
            "Net Acres" => @<PropertyColumn T="Acquisition" TProperty="decimal?" Property="x => x.TotalNetAcres" Title="Net Acres" Sortable="true" Filterable="true" Format="N4" HeaderStyle="width: 110px;" CellStyle="text-align: right;" />,
            
            "Field Check" => @<PropertyColumn T="Acquisition" TProperty="bool" Property="x => x.FieldCheck" Title="Field Check" Sortable="true" Filterable="true" HeaderStyle="width: 100px;" />,
            
            "Closing Status" => @<PropertyColumn T="Acquisition" TProperty="string" Property="x => x.ClosingStatus" Title="Closing Status" Sortable="true" Filterable="true" HeaderStyle="width: 130px;" />,
            
            "SSR In Pay" => @<PropertyColumn T="Acquisition" TProperty="string" Property="x => x.SsrInPay" Title="SSR In Pay" Sortable="true" Filterable="true" HeaderStyle="width: 90px;" />,
            
            "Title Opinion" => @<PropertyColumn T="Acquisition" TProperty="string" Property="x => x.TitleOpinion" Title="Title Opinion" Sortable="true" Filterable="true" HeaderStyle="width: 130px;" />,
            
            "Liens" => @<TemplateColumn T="Acquisition" Title="Liens" Sortable="true" Filterable="true" HeaderStyle="width: 80px;">
                <CellTemplate>
                    @if (context.Item.Liens)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Warning" Size="Size.Small" />
                    }
                </CellTemplate>
            </TemplateColumn>,
            
            "Lien Amount" => @<PropertyColumn T="Acquisition" TProperty="decimal?" Property="x => x.LienAmount" Title="Lien Amount" Sortable="true" Filterable="true" Format="N2" HeaderStyle="width: 120px;" CellStyle="text-align: right;" />,
            
            "Tax Due" => @<PropertyColumn T="Acquisition" TProperty="decimal?" Property="x => x.TaxAmountDue" Title="Tax Due" Sortable="true" Filterable="true" Format="N2" HeaderStyle="width: 110px;" CellStyle="text-align: right;" />,
            
            "Tax Paid" => @<PropertyColumn T="Acquisition" TProperty="decimal?" Property="x => x.TaxAmountPaid" Title="Tax Paid" Sortable="true" Filterable="true" Format="N2" HeaderStyle="width: 110px;" CellStyle="text-align: right;" />,
            
            "Invoice Number" => @<PropertyColumn T="Acquisition" TProperty="string" Property="x => x.InvoiceNumber" Title="Invoice #" Sortable="true" Filterable="true" HeaderStyle="width: 100px;" />,
            
            "Invoice Date" => @<PropertyColumn T="Acquisition" TProperty="DateTime?" Property="x => x.InvoiceDate" Title="Invoice Date" Sortable="true" Filterable="true" Format="MM/dd/yyyy" HeaderStyle="width: 120px;" />,
            
            "Invoice Due Date" => @<PropertyColumn T="Acquisition" TProperty="DateTime?" Property="x => x.InvoiceDueDate" Title="Invoice Due" Sortable="true" Filterable="true" Format="MM/dd/yyyy" HeaderStyle="width: 120px;" />,
            
            "Invoice Paid Date" => @<PropertyColumn T="Acquisition" TProperty="DateTime?" Property="x => x.InvoicePaidDate" Title="Invoice Paid" Sortable="true" Filterable="true" Format="MM/dd/yyyy" HeaderStyle="width: 120px;" />,
            
            "Invoice Total" => @<PropertyColumn T="Acquisition" TProperty="decimal?" Property="x => x.InvoiceTotal" Title="Invoice Total" Sortable="true" Filterable="true" Format="N2" HeaderStyle="width: 120px;" CellStyle="text-align: right;" />,
            
            "Commission" => @<PropertyColumn T="Acquisition" TProperty="decimal?" Property="x => x.Commission" Title="Commission" Sortable="true" Filterable="true" Format="N2" HeaderStyle="width: 110px;" CellStyle="text-align: right;" />,
            
            "Comm %" => @<PropertyColumn T="Acquisition" TProperty="decimal?" Property="x => x.CommissionPercent" Title="Comm %" Sortable="true" Filterable="true" Format="N2" HeaderStyle="width: 80px;" CellStyle="text-align: right;" />,
            
            "Check Stub" => @<PropertyColumn T="Acquisition" TProperty="string" Property="x => x.HaveCheckStub" Title="Check Stub" Sortable="true" Filterable="true" HeaderStyle="width: 100px;" />,
            
            "Stub Desc" => @<PropertyColumn T="Acquisition" TProperty="string" Property="x => x.CheckStubDesc" Title="Stub Desc" Sortable="true" Filterable="true" HeaderStyle="width: 150px;" />,
            
            "Referral Fee" => @<PropertyColumn T="Acquisition" TProperty="decimal?" Property="x => x.ReferralFee" Title="Referral Fee" Sortable="true" Filterable="true" Format="N2" HeaderStyle="width: 110px;" CellStyle="text-align: right;" />,
            
            "Seller Name" => @<TemplateColumn T="Acquisition" Title="Seller Name" SortLabel="Seller Name" HeaderStyle="white-space:nowrap">
                <CellTemplate>@context.Item.AcquisitionSellers.FirstOrDefault()?.SellerName</CellTemplate>
            </TemplateColumn>,
            
            "Seller Last Name" => @<TemplateColumn T="Acquisition" Title="Seller Last Name" SortLabel="Seller Last Name" HeaderStyle="white-space:nowrap">
                <CellTemplate>@context.Item.AcquisitionSellers.FirstOrDefault()?.SellerLastName</CellTemplate>
            </TemplateColumn>,
            
            "Seller Address" => @<TemplateColumn T="Acquisition" Title="Seller Address 1" SortLabel="Seller Address" HeaderStyle="white-space:nowrap">
                <CellTemplate>@context.Item.AcquisitionSellers.FirstOrDefault()?.AddressLine1</CellTemplate>
            </TemplateColumn>,
            
            "Seller Address 2" => @<TemplateColumn T="Acquisition" Title="Seller Address 2" HeaderStyle="white-space:nowrap">
                <CellTemplate>@context.Item.AcquisitionSellers.FirstOrDefault()?.AddressLine2</CellTemplate>
            </TemplateColumn>,
            
            "Seller City" => @<TemplateColumn T="Acquisition" Title="Seller City" SortLabel="Seller City" HeaderStyle="white-space:nowrap">
                <CellTemplate>@context.Item.AcquisitionSellers.FirstOrDefault()?.City</CellTemplate>
            </TemplateColumn>,
            
            "Seller State" => @<TemplateColumn T="Acquisition" Title="Seller State" SortLabel="Seller State" HeaderStyle="white-space:nowrap">
                <CellTemplate>@context.Item.AcquisitionSellers.FirstOrDefault()?.StateCode</CellTemplate>
            </TemplateColumn>,
            
            "Seller Zip Code" => @<TemplateColumn T="Acquisition" Title="Seller Zip" SortLabel="Seller Zip Code" HeaderStyle="white-space:nowrap">
                <CellTemplate>@context.Item.AcquisitionSellers.FirstOrDefault()?.ZipCode</CellTemplate>
            </TemplateColumn>,
            
            "Seller Phone" => @<TemplateColumn T="Acquisition" Title="Seller Phone" SortLabel="Seller Phone" HeaderStyle="white-space:nowrap">
                <CellTemplate>@context.Item.AcquisitionSellers.FirstOrDefault()?.ContactPhone</CellTemplate>
            </TemplateColumn>,
            
            "Seller Fax" => @<TemplateColumn T="Acquisition" Title="Seller Fax" SortLabel="Seller Fax" HeaderStyle="white-space:nowrap">
                <CellTemplate>@context.Item.AcquisitionSellers.FirstOrDefault()?.ContactFax</CellTemplate>
            </TemplateColumn>,
            
            "Seller Email" => @<TemplateColumn T="Acquisition" Title="Seller Email" SortLabel="Seller Email" HeaderStyle="white-space:nowrap">
                <CellTemplate>@context.Item.AcquisitionSellers.FirstOrDefault()?.ContactEmail</CellTemplate>
            </TemplateColumn>,
            
            "Operator Name" => @<TemplateColumn T="Acquisition" Title="Operator" SortLabel="Operator Name" HeaderStyle="white-space:nowrap">
                <CellTemplate>@string.Join(", ", context.Item.AcquisitionOperators.Select(x => x.Operator?.OperatorName).Where(x => !string.IsNullOrEmpty(x)))</CellTemplate>
            </TemplateColumn>,
            
            "County Name" => @<TemplateColumn T="Acquisition" Title="County" SortLabel="County Name" HeaderStyle="white-space:nowrap">
                <CellTemplate>@string.Join(", ", context.Item.AcquisitionCounties.Select(x => x.County?.CountyName).Where(x => !string.IsNullOrEmpty(x)))</CellTemplate>
            </TemplateColumn>,
            
            "Unit Name" => @<TemplateColumn T="Acquisition" Title="Unit Name" SortLabel="Unit Name" HeaderStyle="white-space:nowrap">
                <CellTemplate>@string.Join(", ", context.Item.AcquisitionUnits.Select(x => x.UnitName).Where(x => !string.IsNullOrEmpty(x)))</CellTemplate>
            </TemplateColumn>,
            
            "Unit Interest" => @<TemplateColumn T="Acquisition" Title="Unit Interest" SortLabel="Unit Interest" HeaderStyle="white-space:nowrap">
                <CellTemplate>@string.Join(", ", context.Item.AcquisitionUnits.Select(x => x.UnitInterest).Where(x => x.HasValue))</CellTemplate>
            </TemplateColumn>,

            _ => null
        };
    }
}

