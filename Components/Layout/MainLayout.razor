@inherits LayoutComponentBase
@using MudBlazor
@using Microsoft.AspNetCore.Components.Authorization
@using SSRBlazor.Components.Navigation
@using SSRBlazor.Services
@implements IDisposable
@inject ThemeService ThemeService

@*
    MUDBLAZOR LAYOUT STRUCTURE:
    1. Providers (Theme, Popover, Dialog, Snackbar) are in Routes.razor
    2. MudLayout wraps AppBar, Drawer (optional), and MainContent
    3. MainMenu goes inside MudAppBar for proper dropdown positioning
*@

@* === MAIN LAYOUT CONTAINER === *@
<MudLayout>
    
    @* === APP BAR (contains the menu) === *@
    <MudAppBar Elevation="1" Dense="true" Class="app-menu-bar">
        <MainMenu />
        <MudSpacer />
        <MudIconButton Icon="@(ThemeService.IsDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)" 
                       Color="Color.Inherit" 
                       OnClick="@ThemeService.ToggleDarkMode" 
                       title="Toggle Dark Mode" />
        <AuthorizeView>
            <Authorized Context="authState">
                <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                    <ActivatorContent>
                        <MudAvatar Color="Color.Secondary" Size="Size.Small" Class="mr-2">
                            @GetUserInitials(authState.User.Identity?.Name)
                        </MudAvatar>
                    </ActivatorContent>
                    <ChildContent>
                        <MudMenuItem>
                            <MudText Typo="Typo.body2" Class="px-2">
                                <strong>@authState.User.Identity?.Name</strong>
                            </MudText>
                        </MudMenuItem>
                        <MudDivider />
                        <MudMenuItem Href="/account/logout" Icon="@Icons.Material.Filled.Logout">
                            Logout
                        </MudMenuItem>
                    </ChildContent>
                </MudMenu>
            </Authorized>
            <NotAuthorized>
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" Href="/account/login">Login</MudButton>
            </NotAuthorized>
        </AuthorizeView>
    </MudAppBar>
    
    @* === MAIN CONTENT (page body only) === *@
    <MudMainContent Class="mt-16">
        @* Page Body *@
        <div class="page-content">
            @Body
        </div>
    </MudMainContent>
    
</MudLayout>

@code {
    protected override void OnInitialized()
    {
        ThemeService.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        ThemeService.OnChange -= StateHasChanged;
    }

    private string GetUserInitials(string? userName)
    {
        if (string.IsNullOrWhiteSpace(userName))
            return "?";

        var parts = userName.Split(' ', '@', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 0)
            return "?";

        if (parts.Length == 1)
            return parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpper();

        // Take first letter of first two parts (first name, last name)
        return $"{parts[0][0]}{parts[1][0]}".ToUpper();
    }
}