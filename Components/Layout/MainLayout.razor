@inherits LayoutComponentBase
@using MudBlazor
@using Microsoft.AspNetCore.Components.Authorization
@using SSRBlazor.Components.Navigation
@using SSRBlazor.Services
@implements IDisposable
@inject ThemeService ThemeService

@*
    MUDBLAZOR LAYOUT STRUCTURE:
    1. Providers (Theme, Popover, Dialog, Snackbar) are in Routes.razor
    2. MudLayout wraps AppBar, Drawer (optional), and MainContent
    3. MainMenu goes inside MudAppBar for proper dropdown positioning
*@

@* === MAIN LAYOUT CONTAINER === *@
<MudLayout>
    
    @* === TOP NAVIGATION === *@
    <AuthorizeView>
        <Authorized>
            <div style="position: sticky; top: 0; z-index: 1300; width: 100%;">
                <LegacyMenuBar />
            </div>
        </Authorized>
        <NotAuthorized>
            <MudAppBar Elevation="1" Dense="true" Class="app-menu-bar">
                <MudSpacer />
                <MudIconButton Icon="@(ThemeService.IsDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)" 
                               Color="Color.Inherit" 
                               OnClick="@ThemeService.ToggleDarkMode" 
                               title="Toggle Dark Mode" />
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" Href="/account/login" Class="ml-4">Login</MudButton>
            </MudAppBar>
        </NotAuthorized>
    </AuthorizeView>
    
    @* === MAIN CONTENT === *@
    <MudMainContent>
        @* Page Body *@
        <div class="page-content pa-4">
            @Body
        </div>
    </MudMainContent>
    
</MudLayout>

@code {
    protected override void OnInitialized()
    {
        ThemeService.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        ThemeService.OnChange -= StateHasChanged;
    }

    private string GetUserInitials(string? userName)
    {
        if (string.IsNullOrWhiteSpace(userName))
            return "?";

        var parts = userName.Split(' ', '@', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 0)
            return "?";

        if (parts.Length == 1)
            return parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpper();

        // Take first letter of first two parts (first name, last name)
        return $"{parts[0][0]}{parts[1][0]}".ToUpper();
    }

    private bool ShouldShowToolbar()
    {
        // Show toolbar for authorized users
        return true;
    }

    private string? GetCurrentModule()
    {
        // This would ideally be determined from the current route
        // For now, return null as the toolbar component will handle defaults
        return null;
    }

    private Dictionary<string, object>? GetActionParameters()
    {
        // Return any parameters needed for toolbar actions
        // For now, return null as most actions don't need parameters
        return null;
    }
}