name: Infrastructure Drift Detection

on:
  schedule:
    # Run every day at 6 AM UTC to check for drift
    - cron: '0 6 * * *'
  workflow_dispatch:  # Allow manual triggering

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GKE_CLUSTER_NAME: ${{ vars.GKE_CLUSTER_NAME }}
  GKE_CLUSTER_LOCATION: ${{ vars.GKE_CLUSTER_LOCATION }}

jobs:
  drift-check:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write
      issues: write  # To create issues for drift detection

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

    - name: Set up Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2

    - name: Get GKE cluster credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER_NAME }} \
          --location=${{ env.GKE_CLUSTER_LOCATION }} \
          --project=${{ env.GCP_PROJECT_ID }}

    - name: Set up OpenTofu
      uses: opentofu/setup-opentofu@v1
      with:
        tofu_version: latest
        tofu_wrapper: false

    - name: Initialize OpenTofu
      working-directory: ./deployment/opentofu
      run: tofu init

    - name: Create terraform.tfvars
      working-directory: ./deployment/opentofu
      env:
        TLS_CERT_DATA: ${{ secrets.TLS_CERT_DATA }}
        TLS_KEY_DATA: ${{ secrets.TLS_KEY_DATA }}
      run: |
        cat > terraform.tfvars << EOF
        gcp_project_id       = "${{ env.GCP_PROJECT_ID }}"
        gcp_region          = "us-central1"
        gke_cluster_name    = "${{ env.GKE_CLUSTER_NAME }}"
        gke_cluster_location = "${{ env.GKE_CLUSTER_LOCATION }}"
        tls_cert_data       = "$TLS_CERT_DATA"
        tls_key_data        = "$TLS_KEY_DATA"
        EOF

    - name: Check for infrastructure drift
      id: drift
      working-directory: ./deployment/opentofu
      run: |
        echo "Checking for infrastructure drift..."

        # Run plan with detailed exit code
        # Exit code 0: No changes
        # Exit code 1: Error
        # Exit code 2: Changes detected (drift)
        tofu plan -detailed-exitcode -no-color > plan_output.txt 2>&1
        exit_code=$?

        echo "Plan exit code: $exit_code"

        # Read plan output
        plan_output=$(cat plan_output.txt)
        echo "plan_output<<EOF" >> $GITHUB_OUTPUT
        echo "$plan_output" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        if [ $exit_code -eq 2 ]; then
          echo "drift_detected=true" >> $GITHUB_OUTPUT
          echo "üö® Infrastructure drift detected!"
        elif [ $exit_code -eq 0 ]; then
          echo "drift_detected=false" >> $GITHUB_OUTPUT
          echo "‚úÖ No infrastructure drift detected"
        else
          echo "drift_detected=error" >> $GITHUB_OUTPUT
          echo "‚ùå Error during drift detection"
        fi

        # Don't fail the workflow here, handle in next step
        exit 0

    - name: Create issue for drift detection
      if: steps.drift.outputs.drift_detected == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const title = `üö® Infrastructure Drift Detected - ${new Date().toISOString().split('T')[0]}`;
          const body = `## Infrastructure Drift Detected

          Our daily infrastructure drift check has detected changes between the actual infrastructure and the OpenTofu configuration.

          ### Details
          - **Date**: ${new Date().toISOString()}
          - **Environment**: Production
          - **Cluster**: ${{ env.GKE_CLUSTER_NAME }}
          - **Project**: ${{ env.GCP_PROJECT_ID }}

          ### OpenTofu Plan Output
          \`\`\`terraform
          ${{ steps.drift.outputs.plan_output }}
          \`\`\`

          ### Next Steps
          1. Review the plan output above to understand what changes have been detected
          2. Investigate why the infrastructure has drifted from the configuration
          3. Either:
             - Update the OpenTofu configuration to match the current infrastructure state, OR
             - Apply the OpenTofu configuration to revert the infrastructure to the desired state
          4. Close this issue once the drift has been resolved

          ### Links
          - [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [OpenTofu Configuration](https://github.com/${{ github.repository }}/tree/main/deployment/opentofu)

          ---
          *This issue was automatically created by the infrastructure drift detection workflow.*
          `;

          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['infrastructure', 'drift-detection', 'urgent']
          });

    - name: Notify via Slack (optional)
      if: steps.drift.outputs.drift_detected == 'true' && secrets.SLACK_WEBHOOK_URL != ''
      run: |
        curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"üö® Infrastructure drift detected in ${{ env.GKE_CLUSTER_NAME }}! Check GitHub issues for details."}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}