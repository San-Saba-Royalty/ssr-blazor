name: Build and Deploy to Kubernetes

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

env:
  REGISTRY: docker.io
  IMAGE_NAME: tribehealth/ssrblazor
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME }}
  GKE_CLUSTER_LOCATION: ${{ secrets.GKE_CLUSTER_LOCATION }}

jobs:
  # Build and push Docker image
  build:
    runs-on: ubuntu-latest

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        platforms: linux/amd64
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # Deploy to Kubernetes using OpenTofu
  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'  # Only deploy from main branch

    environment: production  # Use GitHub environment for additional security

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.GCP_PROJECT_ID }}

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

    - name: Get GKE cluster credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER_NAME }} \
          --location=${{ env.GKE_CLUSTER_LOCATION }} \
          --project=${{ env.GCP_PROJECT_ID }}

    - name: Set up OpenTofu
      uses: opentofu/setup-opentofu@v1
      with:
        tofu_version: '1.6.0'

    - name: Initialize OpenTofu
      working-directory: ./deployment/opentofu
      run: tofu init

    - name: Create terraform.tfvars
      working-directory: ./deployment/opentofu
      run: |
        cat > terraform.tfvars << EOF
        gcp_project_id       = "${{ env.GCP_PROJECT_ID }}"
        gcp_region          = "us-central1"
        gke_cluster_name    = "${{ env.GKE_CLUSTER_NAME }}"
        gke_cluster_location = "${{ env.GKE_CLUSTER_LOCATION }}"
        tls_cert_data       = "${{ secrets.TLS_CERT_DATA }}"
        tls_key_data        = "${{ secrets.TLS_KEY_DATA }}"
        EOF

    - name: Validate OpenTofu configuration
      working-directory: ./deployment/opentofu
      run: tofu validate

    - name: Plan OpenTofu changes
      working-directory: ./deployment/opentofu
      run: tofu plan -out=tfplan

    - name: Apply OpenTofu changes
      working-directory: ./deployment/opentofu
      run: tofu apply -auto-approve tfplan

    - name: Update deployment image
      run: |
        # Update the deployment to use the newly built image
        kubectl set image deployment/ssr-deployment \
          ssr-container=${{ needs.build.outputs.image-tag }} \
          -n ssr

        # Wait for rollout to complete
        kubectl rollout status deployment/ssr-deployment -n ssr --timeout=300s

    - name: Verify deployment
      run: |
        kubectl get pods -n ssr -l app=ssr-app
        kubectl get services -n ssr
        kubectl get ingress -n ssr

  # Check deployment health
  health-check:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Wait for deployment to stabilize
      run: sleep 30

    - name: Health check
      run: |
        # Test the application endpoint
        curl -f https://ssr.prometheusags.ai/health || exit 1
      continue-on-error: true